<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Fermi-LAT diffuse model predicted counts image &mdash; gammapy v0.2</title>
    
    <link rel="stylesheet" href="../../_static/gammapy.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://media.readthedocs.org/css/badge_only.css" type="text/css" />
    <link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/underscore.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/doctools.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-doc-embed.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../_static/astropy_logo.ico"/>
    <link rel="top" title="gammapy v0.2" href="../../index.html" />
    <link rel="up" title="Tutorials and Examples" href="../index.html" />
    <link rel="next" title="Catalog &amp; Simulation Images" href="../catalog/index.html" />
    <link rel="prev" title="Crab multi-wavelength SED" href="../crab_mwl_sed/index.html" />

<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'>
<script type="text/javascript" src="../../_static/copybutton.js"></script>


<!-- RTD Extra Head -->



<!-- 
Read the Docs is acting as the canonical URL for your project. 
If you want to change it, more info is available in our docs:
  http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="http://gammapy.readthedocs.org/en/latest/tutorials/npred/" />

<script type="text/javascript">
  // This is included here because other places don't have access to the pagename variable.
  var READTHEDOCS_DATA = {
    project: "gammapy",
    version: "v0.2",
    language: "en",
    page: "tutorials/npred/index",
    builder: "sphinx",
    theme: "bootstrap-astropy",
    docroot: "/docs/",
    source_suffix: ".rst",
    api_host: "https://readthedocs.org",
    commit: "9738ffd45cc7ff63ec8b846e4288f5212b4717db"
  }
  // Old variables
  var doc_version = "v0.2";
  var doc_slug = "gammapy";
  var page_name = "tutorials/npred/index";
  var html_theme = "bootstrap-astropy";
</script>
<!-- RTD Analytics Code -->
<!-- Included in the header because you don't have a footer block. -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17997319-1']);
  _gaq.push(['_trackPageview']);


  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<!-- end RTD Analytics Code -->
<!-- end RTD <extrahead> -->

  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">gamma</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="http://gammapy.readthedocs.io/en/v0.2/search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="../catalog/index.html" title="Catalog &amp; Simulation Images">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="../crab_mwl_sed/index.html" title="Crab multi-wavelength SED">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../../index.html">gammapy v0.2</a>
	 &raquo;
      </li>
      <li><a href="../index.html" accesskey="U">Tutorials and Examples</a> &raquo;</li>
      
      <li>Fermi-LAT diffuse model predicted counts image</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="fermi-lat-diffuse-model-predicted-counts-image">
<span id="tutorials-npred"></span><h1>Fermi-LAT diffuse model predicted counts image<a class="headerlink" href="index.html#fermi-lat-diffuse-model-predicted-counts-image" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference internal" href="../../api/gammapy.data.SpectralCube.html#gammapy.data.SpectralCube" title="gammapy.data.SpectralCube"><tt class="xref py py-obj docutils literal"><span class="pre">SpectralCube</span></tt></a> class allows for image-based analysis in energy
bands. In particular, similar functionality to gtmodel in the Fermi Science
tools <a class="reference internal" href="../../references.html#fssc2013" id="id1">[FSSC2013]</a> is offered in <a class="reference internal" href="../../api/gammapy.data.compute_npred_cube.html#gammapy.data.compute_npred_cube" title="gammapy.data.compute_npred_cube"><tt class="xref py py-obj docutils literal"><span class="pre">compute_npred_cube</span></tt></a>
which generates a predicted instrument PSF-convolved counts cube based on a
provided background model. Unlike the science tools, this implementation is
appropriate for use with large regions of the sky.</p>
<div class="section" id="predicting-counts">
<h2>Predicting Counts<a class="headerlink" href="index.html#predicting-counts" title="Permalink to this headline">¶</a></h2>
<p>The example script below computes the Fermi PSF-convolved predicted counts map
using <a class="reference internal" href="../../api/gammapy.data.SpectralCube.html#gammapy.data.SpectralCube" title="gammapy.data.SpectralCube"><tt class="xref py py-obj docutils literal"><span class="pre">SpectralCube</span></tt></a>. This is then used to produce a Li &amp; Ma significance
image <a class="reference internal" href="../../references.html#lima1983" id="id2">[LiMa1983]</a>. The left image shows the significance image,
while a comparison against the significance image
produced using the Fermi Science tools is shown on the right. These results are
for the Vela region for energies between 10 and 500 GeV.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;Runs commands to produce convolved predicted counts map in current directory.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">Angle</span>
<span class="kn">from</span> <span class="nn">astropy.units</span> <span class="kn">import</span> <span class="n">Quantity</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="p">(</span><span class="n">SpectralCube</span><span class="p">,</span>
                          <span class="n">compute_npred_cube</span><span class="p">,</span>
                          <span class="n">convolve_cube</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="n">FermiVelaRegion</span>
<span class="kn">from</span> <span class="nn">gammapy.irf</span> <span class="kn">import</span> <span class="n">EnergyDependentTablePSF</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;prepare_images&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">prepare_images</span><span class="p">():</span>
    <span class="c"># Reads in data</span>
    <span class="n">background_file</span> <span class="o">=</span> <span class="n">FermiVelaRegion</span><span class="o">.</span><span class="n">filenames</span><span class="p">()[</span><span class="s">&#39;diffuse_model&#39;</span><span class="p">]</span>
    <span class="n">exposure_file</span> <span class="o">=</span> <span class="n">FermiVelaRegion</span><span class="o">.</span><span class="n">filenames</span><span class="p">()[</span><span class="s">&#39;exposure_cube&#39;</span><span class="p">]</span>
    <span class="n">counts_file</span> <span class="o">=</span> <span class="n">FermiVelaRegion</span><span class="o">.</span><span class="n">filenames</span><span class="p">()[</span><span class="s">&#39;counts_cube&#39;</span><span class="p">]</span>
    <span class="n">background_model</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">background_file</span><span class="p">)</span>
    <span class="n">exposure_cube</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exposure_file</span><span class="p">)</span>
    <span class="c"># Add correct units</span>
    <span class="n">exposure_cube</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="n">exposure_cube</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;cm2 s&#39;</span><span class="p">)</span>
    <span class="c"># Re-project background cube</span>
    <span class="n">repro_bg_cube</span> <span class="o">=</span> <span class="n">background_model</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="n">exposure_cube</span><span class="p">)</span>
    <span class="c"># Define energy band required for output</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span> <span class="s">&#39;GeV&#39;</span><span class="p">)</span>

    <span class="c"># Compute the predicted counts cube</span>
    <span class="n">npred_cube</span> <span class="o">=</span> <span class="n">compute_npred_cube</span><span class="p">(</span><span class="n">repro_bg_cube</span><span class="p">,</span> <span class="n">exposure_cube</span><span class="p">,</span> <span class="n">energies</span><span class="p">)</span>

    <span class="c"># Convolve with Energy-dependent Fermi LAT PSF</span>

    <span class="n">psf</span> <span class="o">=</span> <span class="n">EnergyDependentTablePSF</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">FermiVelaRegion</span><span class="o">.</span><span class="n">filenames</span><span class="p">()[</span><span class="s">&#39;psf&#39;</span><span class="p">])</span>
    <span class="n">convolved_npred_cube</span> <span class="o">=</span> <span class="n">convolve_cube</span><span class="p">(</span><span class="n">npred_cube</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span>
                                         <span class="n">offset_max</span><span class="o">=</span><span class="n">Angle</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&#39;deg&#39;</span><span class="p">))</span>

    <span class="c"># Counts data</span>
    <span class="n">counts_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">counts_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">counts_wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">counts_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">counts_cube</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">Quantity</span><span class="p">(</span><span class="n">counts_data</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
                               <span class="n">wcs</span><span class="o">=</span><span class="n">counts_wcs</span><span class="p">,</span>
                               <span class="n">energy</span><span class="o">=</span><span class="n">energies</span><span class="p">)</span>
    <span class="n">counts_cube</span> <span class="o">=</span> <span class="n">counts_cube</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="n">npred_cube</span><span class="p">)</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts_cube</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">convolved_npred_cube</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># Load Fermi tools gtmodel background-only result</span>

    <span class="n">gtmodel</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">FermiVelaRegion</span><span class="o">.</span><span class="n">filenames</span><span class="p">()[</span><span class="s">&#39;background_image&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c"># Ratio for the two background images</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">model</span> <span class="o">/</span> <span class="n">gtmodel</span><span class="p">)</span>

    <span class="c"># Header is required for plotting, so returned here</span>
    <span class="n">wcs</span> <span class="o">=</span> <span class="n">npred_cube</span><span class="o">.</span><span class="n">wcs</span>
    <span class="n">wcs</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">dropaxis</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span> 

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">gtmodel</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">header</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;Runs commands to produce convolved predicted counts map in current directory.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">gammapy.stats</span> <span class="kn">import</span> <span class="n">significance</span>
<span class="kn">from</span> <span class="nn">gammapy.image.utils</span> <span class="kn">import</span> <span class="n">disk_correlate</span>
<span class="kn">from</span> <span class="nn">npred_general</span> <span class="kn">import</span> <span class="n">prepare_images</span>
<span class="kn">from</span> <span class="nn">aplpy</span> <span class="kn">import</span> <span class="n">FITSFigure</span>

<span class="n">model</span><span class="p">,</span> <span class="n">gtmodel</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">prepare_images</span><span class="p">()</span>

<span class="c"># Top hat correlation</span>
<span class="n">correlation_radius</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">correlated_gtmodel</span> <span class="o">=</span> <span class="n">disk_correlate</span><span class="p">(</span><span class="n">gtmodel</span><span class="p">,</span> <span class="n">correlation_radius</span><span class="p">)</span>
<span class="n">correlated_counts</span> <span class="o">=</span> <span class="n">disk_correlate</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">correlation_radius</span><span class="p">)</span>
<span class="n">correlated_model</span> <span class="o">=</span> <span class="n">disk_correlate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">correlation_radius</span><span class="p">)</span>

<span class="c"># Fermi significance</span>
<span class="n">fermi_significance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">significance</span><span class="p">(</span><span class="n">correlated_counts</span><span class="p">,</span> <span class="n">gtmodel</span><span class="p">,</span>
                                                <span class="n">method</span><span class="o">=</span><span class="s">&#39;lima&#39;</span><span class="p">))</span>
<span class="c"># Gammapy significance</span>
<span class="n">significance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">significance</span><span class="p">(</span><span class="n">correlated_counts</span><span class="p">,</span> <span class="n">correlated_model</span><span class="p">,</span>
                                          <span class="n">method</span><span class="o">=</span><span class="s">&#39;lima&#39;</span><span class="p">))</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Gammapy Significance&#39;</span><span class="p">,</span> <span class="s">&#39;Fermi Tools Significance&#39;</span><span class="p">]</span>

<span class="c"># Plot</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">hdu1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">significance</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">FITSFigure</span><span class="p">(</span><span class="n">hdu1</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">convention</span><span class="o">=</span><span class="s">&#39;wells&#39;</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="p">[</span><span class="mf">0.15</span><span class="p">,</span><span class="mf">0.214</span><span class="p">,</span><span class="mf">0.38</span><span class="p">,</span><span class="mf">0.494</span><span class="p">])</span>
<span class="n">f1</span><span class="o">.</span><span class="n">set_tick_labels_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;x-small&#39;</span><span class="p">)</span>
<span class="n">f1</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">set_xformat</span><span class="p">(</span><span class="s">&#39;ddd&#39;</span><span class="p">)</span>
<span class="n">f1</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">set_yformat</span><span class="p">(</span><span class="s">&#39;ddd&#39;</span><span class="p">)</span>
<span class="n">f1</span><span class="o">.</span><span class="n">show_colorscale</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">hdu2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">fermi_significance</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
<span class="n">f2</span> <span class="o">=</span> <span class="n">FITSFigure</span><span class="p">(</span><span class="n">hdu2</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">convention</span><span class="o">=</span><span class="s">&#39;wells&#39;</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="p">[</span><span class="mf">0.56</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.52</span><span class="p">])</span>
<span class="n">f2</span><span class="o">.</span><span class="n">set_tick_labels_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;x-small&#39;</span><span class="p">)</span>
<span class="n">f2</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">set_xformat</span><span class="p">(</span><span class="s">&#39;ddd&#39;</span><span class="p">)</span>
<span class="n">f2</span><span class="o">.</span><span class="n">hide_ytick_labels</span><span class="p">()</span>
<span class="n">f2</span><span class="o">.</span><span class="n">hide_yaxis_label</span><span class="p">()</span>
<span class="n">f2</span><span class="o">.</span><span class="n">show_colorscale</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">f2</span><span class="o">.</span><span class="n">add_colorbar</span><span class="p">()</span>
<span class="n">f2</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">set_width</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">f2</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="s">&#39;right&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.22</span><span class="p">,</span><span class="mf">0.72</span><span class="p">,</span><span class="s">&quot;Gammapy Significance&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;14&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.63</span><span class="p">,</span><span class="mf">0.72</span><span class="p">,</span><span class="s">&quot;Fermi Tools Significance&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;14&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference external" href="npred_convolved_significance.py">Source code</a>)</p>
</div>
<div class="section" id="checks">
<h2>Checks<a class="headerlink" href="index.html#checks" title="Permalink to this headline">¶</a></h2>
<p>For small regions, the predicted counts cube and significance images may be
checked against the gtmodel output. The Vela region shown above is taken in
this example in one energy band with the parameters outlined in the
<a class="reference external" href="https://github.com/gammapy/gammapy-extra/blob/master/datasets/vela_region/README.rst">README file for FermiVelaRegion</a>.</p>
<p>Images for the predicted background counts in this region in the Gammapy case
(left) and Fermi Science Tools gtmodel case (center) are shown below, based on
the differential flux contribution of the Fermi diffuse model gll_iem_v05_rev1.fit.
The image on the right shows the ratio. <strong>Note that the colorbar scale applies only to
the ratio image.</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;Runs commands to produce convolved predicted counts map in current directory.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">npred_general</span> <span class="kn">import</span> <span class="n">prepare_images</span>
<span class="kn">from</span> <span class="nn">aplpy</span> <span class="kn">import</span> <span class="n">FITSFigure</span>

<span class="n">model</span><span class="p">,</span> <span class="n">gtmodel</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">prepare_images</span><span class="p">()</span>

<span class="c"># Plotting</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">hdu1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">FITSFigure</span><span class="p">(</span><span class="n">hdu1</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">convention</span><span class="o">=</span><span class="s">&#39;wells&#39;</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="p">[</span><span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.264</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.234</span><span class="p">])</span>
<span class="n">f1</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;x-small&#39;</span><span class="p">)</span>
<span class="n">f1</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">set_xformat</span><span class="p">(</span><span class="s">&#39;ddd&#39;</span><span class="p">)</span>
<span class="n">f1</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">set_yformat</span><span class="p">(</span><span class="s">&#39;ddd&#39;</span><span class="p">)</span>
<span class="n">f1</span><span class="o">.</span><span class="n">axis_labels</span><span class="o">.</span><span class="n">hide_x</span><span class="p">()</span>
<span class="n">f1</span><span class="o">.</span><span class="n">show_colorscale</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">hdu2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">gtmodel</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
<span class="n">f2</span> <span class="o">=</span> <span class="n">FITSFigure</span><span class="p">(</span><span class="n">hdu2</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">convention</span><span class="o">=</span><span class="s">&#39;wells&#39;</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="p">[</span><span class="mf">0.38</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">])</span>
<span class="n">f2</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;x-small&#39;</span><span class="p">)</span>
<span class="n">f2</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">set_xformat</span><span class="p">(</span><span class="s">&#39;ddd&#39;</span><span class="p">)</span>
<span class="n">f2</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">hide_y</span><span class="p">()</span>
<span class="n">f2</span><span class="o">.</span><span class="n">axis_labels</span><span class="o">.</span><span class="n">hide_y</span><span class="p">()</span>
<span class="n">f2</span><span class="o">.</span><span class="n">show_colorscale</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">f2</span><span class="o">.</span><span class="n">add_colorbar</span><span class="p">()</span>
<span class="n">f2</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">set_width</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">f2</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="s">&#39;right&#39;</span><span class="p">)</span>

<span class="n">hdu3</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
<span class="n">f3</span> <span class="o">=</span> <span class="n">FITSFigure</span><span class="p">(</span><span class="n">hdu3</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">convention</span><span class="o">=</span><span class="s">&#39;wells&#39;</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="p">[</span><span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">])</span>
<span class="n">f3</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">set_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s">&#39;x-small&#39;</span><span class="p">)</span>
<span class="n">f3</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">set_xformat</span><span class="p">(</span><span class="s">&#39;ddd&#39;</span><span class="p">)</span>
<span class="n">f3</span><span class="o">.</span><span class="n">tick_labels</span><span class="o">.</span><span class="n">hide_y</span><span class="p">()</span>
<span class="n">f3</span><span class="o">.</span><span class="n">axis_labels</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
<span class="n">f3</span><span class="o">.</span><span class="n">show_colorscale</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>
<span class="n">f3</span><span class="o">.</span><span class="n">add_colorbar</span><span class="p">()</span>
<span class="n">f3</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">set_width</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">f3</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="s">&#39;right&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.19</span><span class="p">,</span> <span class="mf">0.53</span><span class="p">,</span> <span class="s">&quot;Gammapy Background&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s">&#39;9&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.39</span><span class="p">,</span> <span class="mf">0.53</span><span class="p">,</span> <span class="s">&quot;Fermi Tools Background&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s">&#39;9&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="mf">0.53</span><span class="p">,</span> <span class="s">&quot;Ratio: </span><span class="se">\n</span><span class="s"> Gammapy/Fermi Tools&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s">&#39;9&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference external" href="npred_convolved.py">Source code</a>)</p>
<p>We may compare these against the true counts observed by Fermi LAT in this region
for the same parameters:</p>
<blockquote>
<div><ul class="simple">
<li>True total counts: 1551</li>
<li>Fermi Tools gtmodel predicted background counts: 265</li>
<li>Gammapy predicted background counts: 282</li>
</ul>
</div></blockquote>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="index.html#">Fermi-LAT diffuse model predicted counts image</a><ul>
<li><a class="reference internal" href="index.html#predicting-counts">Predicting Counts</a></li>
<li><a class="reference internal" href="index.html#checks">Checks</a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../../_sources/tutorials/npred/index.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="index.html#">Back to Top</a></p>
  <p>
    &copy; Copyright 2015, The Gammapy developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.2. &nbsp;
    Last built 13 Apr 2015. <br/>
  </p>
</footer>
  </body>
</html>