<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gammapy.utils.pyfact &mdash; gammapy v0.3</title>
    
    <link rel="stylesheet" href="../../../_static/gammapy.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://media.readthedocs.org/css/badge_only.css" type="text/css" />
    <link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/underscore.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/doctools.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-doc-embed.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="top" title="gammapy v0.3" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />

<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../../../_static/copybutton.js"></script>


<!-- RTD Extra Head -->



<!-- 
Read the Docs is acting as the canonical URL for your project. 
If you want to change it, more info is available in our docs:
  http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="http://gammapy.readthedocs.org/en/latest/_modules/gammapy/utils/pyfact.html" />

<script type="text/javascript">
  // This is included here because other places don't have access to the pagename variable.
  var READTHEDOCS_DATA = {
    project: "gammapy",
    version: "v0.3",
    language: "en",
    page: "_modules/gammapy/utils/pyfact",
    builder: "sphinx",
    theme: "bootstrap-astropy",
    docroot: "/docs/",
    source_suffix: ".rst",
    api_host: "https://readthedocs.org/",
    commit: "ca867804d285620b924a351759160108b986f5bd"
  }
  // Old variables
  var doc_version = "v0.3";
  var doc_slug = "gammapy";
  var page_name = "_modules/gammapy/utils/pyfact";
  var html_theme = "bootstrap-astropy";
</script>
<!-- RTD Analytics Code -->
<!-- Included in the header because you don't have a footer block. -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17997319-1']);
  _gaq.push(['_trackPageview']);


  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<!-- end RTD Analytics Code -->
<!-- end RTD <extrahead> -->

  </head>
  <body role="document">
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">gamma</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="http://gammapy.readthedocs.io/en/v0.3/search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">gammapy v0.3</a>
	 &raquo;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gammapy.utils.pyfact</h1><div class="highlight"><pre>
<span class="c"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="sd">&quot;&quot;&quot;PyFACT compatibility module.</span>

<span class="sd">This module contains a few functions and classes from PyFACT:</span>

<span class="sd">- https://github.com/mraue/pyfact</span>
<span class="sd">- https://github.com/gammapy/gammapy/pull/68</span>

<span class="sd">TODO: This is a short-term solution until we find time to refactor</span>
<span class="sd">this functionality into gammapy.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span><span class="p">,</span> <span class="n">TimeDelta</span>
<span class="kn">from</span> <span class="nn">..stats</span> <span class="kn">import</span> <span class="n">significance_on_off</span>
<span class="kn">from</span> <span class="nn">..irf</span> <span class="kn">import</span> <span class="p">(</span><span class="n">np_to_rmf</span><span class="p">,</span>
                   <span class="n">EnergyDispersion</span><span class="p">,</span>
                   <span class="n">EffectiveAreaTable</span><span class="p">,</span>
                   <span class="p">)</span>
<span class="kn">from</span> <span class="nn">..spectrum</span> <span class="kn">import</span> <span class="n">np_to_pha</span>
<span class="kn">from</span> <span class="nn">..version</span> <span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span> <span class="nn">..utils.random</span> <span class="kn">import</span> <span class="n">get_random_state</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ChisquareFitter&#39;</span><span class="p">,</span>
           <span class="s">&#39;SkyCircle&#39;</span><span class="p">,</span>
           <span class="s">&#39;SkyCoord&#39;</span><span class="p">,</span>
           <span class="s">&#39;circle_circle_intersection_array&#39;</span><span class="p">,</span>
           <span class="s">&#39;circle_circle_intersection_float&#39;</span><span class="p">,</span>
           <span class="s">&#39;create_sky_map&#39;</span><span class="p">,</span>
           <span class="s">&#39;get_cam_acc&#39;</span><span class="p">,</span>
           <span class="s">&#39;get_exclusion_region_map&#39;</span><span class="p">,</span>
           <span class="s">&#39;get_sky_mask_circle&#39;</span><span class="p">,</span>
           <span class="s">&#39;get_sky_mask_ring&#39;</span><span class="p">,</span>
           <span class="s">&#39;oversample_sky_map&#39;</span><span class="p">,</span>
           <span class="s">&#39;plot_skymaps&#39;</span><span class="p">,</span>
           <span class="s">&#39;skycircle_from_str&#39;</span><span class="p">,</span>
           <span class="s">&#39;plot_th1&#39;</span><span class="p">,</span>
           <span class="s">&#39;fit_th1&#39;</span><span class="p">,</span>
           <span class="s">&#39;root_1dhist_to_array&#39;</span><span class="p">,</span>
           <span class="s">&#39;root_2dhist_to_array&#39;</span><span class="p">,</span>
           <span class="s">&#39;root_axis_to_array&#39;</span><span class="p">,</span>
           <span class="s">&#39;root_th1_to_fitstable&#39;</span><span class="p">,</span>
           <span class="s">&#39;cta_irf_root_to_fits&#39;</span><span class="p">,</span>
           <span class="p">]</span>


<div class="viewcode-block" id="ChisquareFitter"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.ChisquareFitter.html#gammapy.utils.pyfact.ChisquareFitter">[docs]</a><span class="k">class</span> <span class="nc">ChisquareFitter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience class to perform Chi^2 fits.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    fitfunc : function</span>
<span class="sd">        Fitfunction</span>
<span class="sd">    results : array</span>
<span class="sd">        Fit results from scipy.optimize.leastsq()</span>
<span class="sd">    chi_arr : float array</span>
<span class="sd">        Array with the final chi values</span>
<span class="sd">    chi2 : float</span>
<span class="sd">        Summed Chi^2</span>
<span class="sd">    dof : float</span>
<span class="sd">        Degrees of freedom</span>
<span class="sd">    prob : float</span>
<span class="sd">        Probability of the fit</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    fitfunc : function</span>
<span class="sd">        Fit function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitfunc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitfunc</span> <span class="o">=</span> <span class="n">fitfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="ChisquareFitter.fit_data"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.ChisquareFitter.html#gammapy.utils.pyfact.ChisquareFitter.fit_data">[docs]</a>    <span class="k">def</span> <span class="nf">fit_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform actual fit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        p0 : float array</span>
<span class="sd">            Start parameters</span>
<span class="sd">        x, y, y_err : float arrays</span>
<span class="sd">            Data to be fitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">leastsq</span>
        <span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">gammainc</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chi_func</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_err</span><span class="p">),</span> <span class="n">full_output</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chi_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chi_arr</span><span class="p">,</span> <span class="mf">2.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
            <span class="c"># self.prob = scipy.special.gammainc(.5 * self.dof, .5 * self.chi2) / scipy.special.gamma(.5 * self.dof)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prob</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">gammainc</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dof</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ChisquareFitter.chi_func"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.ChisquareFitter.html#gammapy.utils.pyfact.ChisquareFitter.chi_func">[docs]</a>    <span class="k">def</span> <span class="nf">chi_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns Chi&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">err</span>  <span class="c"># Distance to the target function</span>
</div>
<div class="viewcode-block" id="ChisquareFitter.print_results"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.ChisquareFitter.html#gammapy.utils.pyfact.ChisquareFitter.print_results">[docs]</a>    <span class="k">def</span> <span class="nf">print_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints out results to the command line using the logging module.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;No fit results to report since no fit has been performed yet&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Fit was successful!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Fitting failed!&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Message: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Chi^2  : {0:f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chi2</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;d.o.f. : {0:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dof</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Prob.  : {0:.4e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prob</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;P{0}     : {1:.4e} +/- {2:.4e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span>
                                                                     <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;P{0}     : {1:.4e}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="SkyCircle"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.SkyCircle.html#gammapy.utils.pyfact.SkyCircle">[docs]</a><span class="k">class</span> <span class="nc">SkyCircle</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A circle on the sky.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A circle on the sky.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coord : SkyCoord</span>
<span class="sd">            Coordinates of the circle center (RA, Dec)</span>
<span class="sd">        r : float</span>
<span class="sd">            Radius of the circle (deg).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span>

<div class="viewcode-block" id="SkyCircle.contains"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.SkyCircle.html#gammapy.utils.pyfact.SkyCircle.contains">[docs]</a>    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the coordinate lies inside the circle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c : SkyCoord</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        contains : bool</span>
<span class="sd">            True if c lies in the SkyCircle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span>
</div>
<div class="viewcode-block" id="SkyCircle.intersects"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.SkyCircle.html#gammapy.utils.pyfact.SkyCircle.intersects">[docs]</a>    <span class="k">def</span> <span class="nf">intersects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if two sky circles overlap.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sc : SkyCircle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">+</span> <span class="n">sc</span><span class="o">.</span><span class="n">r</span>

</div></div>
<div class="viewcode-block" id="SkyCoord"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.SkyCoord.html#gammapy.utils.pyfact.SkyCoord">[docs]</a><span class="k">class</span> <span class="nc">SkyCoord</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Sky coordinate in RA and Dec. All units should be degree.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sky coordinate in RA and Dec. All units should be degree.</span>

<span class="sd">        In the current implementation it should also work with arrays,</span>
<span class="sd">        though one has to be careful in dist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ra : float/array</span>
<span class="sd">            Right ascension of the coordinate.</span>
<span class="sd">        dec : float/array</span>
<span class="sd">            Declination of the coordinate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span>

<div class="viewcode-block" id="SkyCoord.dist"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.SkyCoord.html#gammapy.utils.pyfact.SkyCoord.dist">[docs]</a>    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the distance of the coordinates in degree following the haversine formula,</span>
<span class="sd">        see e.g. http://en.wikipedia.org/wiki/Great-circle_distance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c : SkyCoord</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        distance : float</span>
<span class="sd">            Return the distance of the coordinates in degree following the haversine formula.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        http://en.wikipedia.org/wiki/Great-circle_distance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">360.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span>
                                      <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">/</span> <span class="mf">180.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">dec</span> <span class="o">/</span> <span class="mf">180.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>\
                                          <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span> <span class="o">/</span> <span class="mf">360.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">180.</span>

</div></div>
<div class="viewcode-block" id="circle_circle_intersection_array"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.circle_circle_intersection_array.html#gammapy.utils.pyfact.circle_circle_intersection_array">[docs]</a><span class="k">def</span> <span class="nf">circle_circle_intersection_array</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate overlap area between two circles on the sphere.</span>

<span class="sd">    Works _only_ with numpy arrays of equal length.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    R : array</span>
<span class="sd">        Radius of the first circle.</span>
<span class="sd">    r : array</span>
<span class="sd">        Radius of the second circle.</span>
<span class="sd">    d : array</span>
<span class="sd">        Distance of the two circle (center to center).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    area : array</span>
<span class="sd">        Overlap area between the two circles (steradian).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Define a few useful functions</span>
    <span class="n">X</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="n">R</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="n">R</span> <span class="o">*</span> <span class="n">R</span> <span class="o">-</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">d</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">r</span> <span class="o">-</span> <span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">r</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
    <span class="n">mask1</span> <span class="o">=</span> <span class="n">R</span> <span class="o">&gt;=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">r</span>
    <span class="k">if</span> <span class="n">mask1</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">result</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">R</span>
    <span class="k">if</span> <span class="n">mask2</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">result</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">+</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">R</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">Y</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Z</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">result</span>

</div>
<div class="viewcode-block" id="circle_circle_intersection_float"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.circle_circle_intersection_float.html#gammapy.utils.pyfact.circle_circle_intersection_float">[docs]</a><span class="k">def</span> <span class="nf">circle_circle_intersection_float</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate overlap area between two circles on the sphere.</span>

<span class="sd">    Works _only_ with floats.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    R : float</span>
<span class="sd">        Radius of the first circle.</span>
<span class="sd">    r : float</span>
<span class="sd">        Radius of the second circle.</span>
<span class="sd">    d : float</span>
<span class="sd">        Distance of the two circle (center to center).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    area : float</span>
<span class="sd">        Overlap area between the two circles (steradian).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Define a few useful functions</span>
    <span class="n">X</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="n">R</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="n">R</span> <span class="o">*</span> <span class="n">R</span> <span class="o">-</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">d</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">d</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">r</span> <span class="o">-</span> <span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">r</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">R</span> <span class="o">&gt;=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span> <span class="o">**</span> <span class="mf">2.</span>
    <span class="k">elif</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">R</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R</span> <span class="o">**</span> <span class="mf">2.</span>
    <span class="k">elif</span> <span class="n">R</span> <span class="o">+</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">r</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">R</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">Y</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Z</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>

</div>
<span class="k">def</span> <span class="nf">sim_evlist</span><span class="p">(</span><span class="n">flux</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">obstime</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
               <span class="n">arf</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">rmf</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">extra</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">output_filename_base</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">write_pha</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">do_graphical_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
               <span class="n">loglevel</span><span class="o">=</span><span class="s">&#39;INFO&#39;</span><span class="p">,</span>
               <span class="n">random_state</span><span class="o">=</span><span class="s">&#39;random-seed&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simulate IACT eventlist using an ARF file.</span>

<span class="sd">    TODO: describe.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    random_state : {int, &#39;random-seed&#39;, &#39;global-rng&#39;, `~numpy.random.RandomState`}</span>
<span class="sd">        Defines random number generator initialisation.</span>
<span class="sd">        Passed to `~gammapy.utils.random.get_random_state`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TODO</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">UnivariateSpline</span>
    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

    <span class="n">random_state</span> <span class="o">=</span> <span class="n">get_random_state</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>

    <span class="c">#---------------------------------------------------------------------------</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Exposure: {0} h&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obstime</span><span class="p">))</span>
    <span class="n">obstime</span> <span class="o">*=</span> <span class="mf">3600.</span>  <span class="c"># observation time in seconds</span>

    <span class="n">obj_ra</span><span class="p">,</span> <span class="n">obj_dec</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">pnt_ra</span><span class="p">,</span> <span class="n">pnt_dec</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
    <span class="n">t_min</span> <span class="o">=</span> <span class="mf">24600.</span>

    <span class="n">objcosdec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">obj_dec</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Read ARF, RMF, and extra file</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;ARF: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arf</span><span class="p">))</span>
    <span class="n">arf_obj</span> <span class="o">=</span> <span class="n">EffectiveAreaTable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">arf</span><span class="p">)</span>
    <span class="n">ea</span> <span class="o">=</span> <span class="n">arf_obj</span><span class="o">.</span><span class="n">effective_area</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ea_erange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">arf_obj</span><span class="o">.</span><span class="n">energy_lo</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">arf_obj</span><span class="o">.</span><span class="n">energy_hi</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">del</span> <span class="n">arf_obj</span>

    <span class="c"># DEBUG</span>
    <span class="c"># ea /= irf_data[:,4]</span>

    <span class="k">if</span> <span class="n">rmf</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RMF: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rmf</span><span class="p">))</span>
        <span class="n">edisp</span> <span class="o">=</span> <span class="n">EnergyDispersion</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">rmf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">edisp</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Extra file: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extra</span><span class="p">))</span>
        <span class="n">extraf</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Using effective area with 80</span><span class="si">% c</span><span class="s">ontainment from extra file&#39;</span><span class="p">)</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="n">extraf</span><span class="p">[</span><span class="s">&#39;EA80&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;VAL&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="o">.</span><span class="mi">8</span>  <span class="c"># 100% effective area</span>
        <span class="n">ea_erange</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">extraf</span><span class="p">[</span><span class="s">&#39;EA80&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;BIN_LO&#39;</span><span class="p">),</span> <span class="n">extraf</span><span class="p">[</span><span class="s">&#39;EA80&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;BIN_HI&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Assuming energy independent 80</span><span class="si">% c</span><span class="s">ut efficiency for ARF file.&#39;</span><span class="p">)</span>
        <span class="n">ea</span> <span class="o">/=</span> <span class="o">.</span><span class="mi">80</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Signal</span>

    <span class="c"># log_e_cen = (irf_data[:,0] + irf_data[:,1]) / 2.</span>
    <span class="n">e_cen</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">**</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ea_erange</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">ea_erange</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>

    <span class="n">ea_loge_step_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ea_erange</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">ea_erange</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;ea_loge_step_mean = {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ea_loge_step_mean</span><span class="p">))</span>

    <span class="c"># Resample effective area to increase precision</span>
    <span class="k">if</span> <span class="n">ea_loge_step_mean</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">elog10step</span> <span class="o">=</span> <span class="o">.</span><span class="mo">05</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Resampling effective area in log10(EA) vs log10(E) (elog10step = {0})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elog10step</span><span class="p">))</span>
        <span class="n">ea_spl</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">e_cen</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">e_cen</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">e_cen</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">e_cen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">step</span><span class="o">=</span><span class="n">elog10step</span><span class="p">)</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">ea_spl</span><span class="p">(</span><span class="n">e_cen</span><span class="p">)</span>

    <span class="c"># DEBUG plot</span>
    <span class="c"># plt.loglog(e_cen_s, ea_s, )</span>
    <span class="c"># plt.loglog(e_cen, ea, &#39;+&#39;)</span>
    <span class="c"># plt.show()</span>

    <span class="n">func_pl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">flux_f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">func_pl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mf">3.45E-11</span> <span class="o">*</span> <span class="n">flux</span><span class="p">,</span> <span class="mf">2.63</span><span class="p">))</span>

    <span class="n">f_test</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">e_cen</span><span class="p">,</span> <span class="n">ea</span> <span class="o">*</span> <span class="n">flux_f</span><span class="p">(</span><span class="n">e_cen</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1E4</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># m^2 &gt; cm^2</span>

    <span class="k">if</span> <span class="n">rmf</span><span class="p">:</span>
        <span class="n">log_e_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">edisp</span><span class="o">.</span><span class="n">energy_bounds</span><span class="p">(</span><span class="s">&#39;true&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_e_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ea_erange</span><span class="p">)</span>

    <span class="c"># Calculate event numbers for the RMF bins</span>
    <span class="k">def</span> <span class="nf">get_int_rate</span><span class="p">(</span><span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">emin</span> <span class="o">&lt;</span> <span class="n">e_cen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">emax</span> <span class="o">&gt;</span> <span class="n">e_cen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f_test</span><span class="o">.</span><span class="n">integral</span><span class="p">(</span><span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">)</span>
    <span class="n">int_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_int_rate</span><span class="p">(</span><span class="mf">10.</span> <span class="o">**</span> <span class="n">el</span><span class="p">,</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">eh</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">eh</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">log_e_steps</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">log_e_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">:])])</span>
    <span class="c"># Sanity</span>
    <span class="n">int_rate</span><span class="p">[</span><span class="n">int_rate</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c"># DEBUG</span>
    <span class="c"># int_rate_s = int_rate</span>

    <span class="k">if</span> <span class="n">rmf</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Photon rate before RM = {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">int_rate</span><span class="p">)))</span>
        <span class="c"># Apply energy distribution matrix</span>
        <span class="n">int_rate</span> <span class="o">=</span> <span class="n">edisp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">int_rate</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Photon rate after RM = {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">int_rate</span><span class="p">)))</span>

    <span class="c"># DEBUG plots</span>
    <span class="c"># plt.figure(1)</span>
    <span class="c"># plt.semilogy(log_e_steps[:-1], int_rate_s, &#39;o&#39;, label=&#39;PRE RMF&#39;)</span>
    <span class="c"># #plt.plot(log_e_steps[:-1], int_rate_s, &#39;o&#39;, label=&#39;PRE RMF&#39;)</span>
    <span class="c"># if rmf :</span>
    <span class="c">#    plt.semilogy(np.log10(rm_ebounds[:-1]), int_rate, &#39;+&#39;, label=&#39;POST RMF&#39;)</span>
    <span class="c"># plt.ylim(1E-6,1.)</span>
    <span class="c"># plt.legend()</span>
    <span class="c"># plt.show()</span>
    <span class="c"># #sys.exit(0)</span>

    <span class="c"># Calculate cumulative event numbers</span>
    <span class="n">int_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">int_rate</span><span class="p">)</span>
    <span class="n">int_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">int_rate</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rmf</span><span class="p">:</span>
        <span class="c"># log_e_steps = (np.log10(rm_ebounds[1:]) + np.log10(rm_ebounds[:-1])) / 2.</span>
        <span class="n">log_e_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">edisp</span><span class="o">.</span><span class="n">energy_bounds</span><span class="p">(</span><span class="s">&#39;true&#39;</span><span class="p">))</span>

    <span class="c"># Filter out low and high values to avoid spline problems at the edges</span>
    <span class="n">istart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">int_rate</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">istart</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">istop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">int_rate</span> <span class="o">/</span> <span class="n">int_all</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="o">-</span> <span class="mf">1e-4</span><span class="p">)</span>  <span class="c"># This value dictates the dynamic range at the high energy end</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;istart = {0}, istop = {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">istart</span><span class="p">,</span> <span class="n">istop</span><span class="p">))</span>

    <span class="c"># DEBUG plots</span>
    <span class="c"># plt.plot(int_rate[istart:-istop] / int_all, log_e_steps[istart + 1:-istop], &#39;+&#39;)</span>
    <span class="c"># plt.show()</span>

    <span class="c"># DEBUG plots</span>
    <span class="c"># plt.hist(int_rate[istart:-istop] / int_all)</span>
    <span class="c"># plt.show()</span>

    <span class="n">ev_gen_f</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">int_rate</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="o">-</span><span class="n">istop</span><span class="p">]</span> <span class="o">/</span> <span class="n">int_all</span><span class="p">,</span>
                                <span class="n">log_e_steps</span><span class="p">[</span><span class="n">istart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="n">istop</span><span class="p">],</span>
                                <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># # DEBUG plot</span>
    <span class="c"># plt.plot(np.linspace(0.,1.,100), ev_gen_f(np.linspace(0.,1.,100)), &#39;o&#39;)</span>
    <span class="c"># plt.show()</span>

    <span class="c"># Test event generator function</span>
    <span class="n">n_a_t</span> <span class="o">=</span> <span class="mf">100.</span>
    <span class="n">a_t</span> <span class="o">=</span> <span class="n">ev_gen_f</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">n_a_t</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Test ev_gen_f, (v = 0 / #v) = {0}, (v = NaN / #v) = {1}&#39;</span>
                  <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a_t</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_a_t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a_t</span><span class="p">))</span> <span class="o">/</span> <span class="n">n_a_t</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a_t</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_a_t</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a_t</span><span class="p">))</span> <span class="o">/</span> <span class="n">n_a_t</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mo">05</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Could not generate event generator function for photons. &#39;</span>
                        <span class="s">&#39;Try to decrease the upper cut-off value in the code.&#39;</span><span class="p">)</span>

    <span class="c"># Calculate total number of photon events</span>
    <span class="n">n_events</span> <span class="o">=</span> <span class="n">int_all</span> <span class="o">*</span> <span class="n">obstime</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Number of photons : {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_events</span><span class="p">))</span>

    <span class="c"># Generate energy event list</span>
    <span class="n">evlist_e</span> <span class="o">=</span> <span class="n">ev_gen_f</span><span class="p">(</span><span class="n">random_state</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_events</span><span class="p">))</span>

    <span class="c"># Sanity</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Number of photons with E = NaN : {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">evlist_e</span><span class="p">))))</span>
    <span class="n">evlist_e</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">evlist_e</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c"># # DEBUG plot</span>
    <span class="c"># plt.figure(1)</span>
    <span class="c"># plt.hist(evlist_e, range=[-2.,2.], bins=20)</span>
    <span class="c"># #plt.show()</span>
    <span class="c"># sys.exit(0)</span>

    <span class="c">#------------------------------------------------------</span>
    <span class="c"># Apply PSF</span>

    <span class="c"># Broken power law fit function, normalized at break energy</span>
    <span class="n">bpl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">evlist_psf</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">extraf</span><span class="p">[</span><span class="s">&#39;ANGRES68&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">((</span><span class="n">d</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;BIN_LO&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;BIN_HI&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;VAL&#39;</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">evlist_psf</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">evlist_e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">psf_p1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">5.5E-2</span><span class="p">,</span> <span class="o">.</span><span class="mi">42</span><span class="p">,</span> <span class="o">.</span><span class="mi">19</span><span class="p">]</span>  <span class="c"># Fit from SubarrayE_IFAE_50hours_20101102</span>
        <span class="n">evlist_psf</span> <span class="o">=</span> <span class="n">bpl</span><span class="p">(</span><span class="n">psf_p1</span><span class="p">,</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">evlist_e</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Using dummy PSF extracted from SubarrayE_IFAE_50hours_20101102&#39;</span><span class="p">)</span>

    <span class="n">evlist_dec</span> <span class="o">=</span> <span class="n">obj_dec</span> <span class="o">+</span> <span class="n">random_state</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span> <span class="o">*</span> <span class="n">evlist_psf</span>
    <span class="n">evlist_ra</span> <span class="o">=</span> <span class="n">obj_ra</span> <span class="o">+</span> <span class="n">random_state</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span> <span class="o">*</span> <span class="n">evlist_psf</span> <span class="o">/</span> <span class="n">objcosdec</span>

    <span class="n">evlist_t</span> <span class="o">=</span> <span class="n">t_min</span> <span class="o">+</span> <span class="n">obstime</span> <span class="o">*</span> <span class="n">random_state</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span> <span class="o">/</span> <span class="mf">86400.</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Background</span>

    <span class="c"># plt.figure(1)</span>

    <span class="n">p_rate_area</span><span class="p">,</span> <span class="n">log_e_cen</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">extraf</span><span class="p">[</span><span class="s">&#39;BGRATED&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">p_rate_area</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;VAL&#39;</span><span class="p">)</span>
        <span class="n">log_e_cen</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;BIN_LO&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;BIN_HI&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="c"># g = scipy.interpolate.UnivariateSpline((d.field(&#39;BIN_LO&#39;) + d.field(&#39;BIN_HI&#39;)) / 2., d.field(&#39;VAL&#39;), s=0, k=1)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Using dummy background rate extracted from SubarrayE_IFAE_50hours_20101102&#39;</span><span class="p">)</span>
        <span class="n">bgrate_p1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">9.</span><span class="p">,</span> <span class="mf">5.E-4</span><span class="p">,</span> <span class="mf">1.44</span><span class="p">,</span> <span class="o">.</span><span class="mi">49</span><span class="p">]</span>  <span class="c"># Fit from SubarrayE_IFAE_50hours_20101102</span>
        <span class="n">log_e_cen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">35.</span><span class="p">)</span>
        <span class="n">p_rate_area</span> <span class="o">=</span> <span class="n">bpl</span><span class="p">(</span><span class="n">bgrate_p1</span><span class="p">,</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">log_e_cen</span><span class="p">)</span>
        <span class="n">p_rate_area</span><span class="p">[</span><span class="n">log_e_cen</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">4</span>

    <span class="c"># DEBUG plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">log_e_cen</span><span class="p">,</span> <span class="n">p_rate_area</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">p_rate_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p_rate_area</span><span class="p">)</span>

    <span class="n">ev_gen_f</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">p_rate_area</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p_rate_area</span><span class="p">),</span>
                                <span class="n">log_e_cen</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">cam_acc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mf">0.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">**</span> <span class="p">((</span><span class="mf">0.</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">cam_acc_par</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.5</span><span class="p">)</span>

    <span class="n">r_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
    <span class="n">int_cam_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r_steps</span><span class="p">):</span>
        <span class="n">int_cam_acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cam_acc</span><span class="p">(</span><span class="n">cam_acc_par</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">r</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">n_events_bg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p_rate_total</span> <span class="o">*</span> <span class="n">obstime</span> <span class="o">*</span> <span class="n">int_cam_acc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Number of protons : {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_events_bg</span><span class="p">))</span>

    <span class="n">tplt_multi</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">evlist_bg_e</span> <span class="o">=</span> <span class="n">ev_gen_f</span><span class="p">(</span><span class="n">random_state</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_events_bg</span> <span class="o">*</span> <span class="p">(</span><span class="n">tplt_multi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="n">temp42</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cam_acc</span><span class="p">(</span><span class="n">cam_acc_par</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ev_gen_f2</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">int_cam_acc</span> <span class="o">/</span> <span class="n">temp42</span><span class="p">,</span>
                                 <span class="n">r_steps</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">evlist_bg_r</span> <span class="o">=</span> <span class="n">ev_gen_f2</span><span class="p">(</span><span class="n">random_state</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_events_bg</span> <span class="o">*</span> <span class="p">(</span><span class="n">tplt_multi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="n">r_max</span> <span class="o">=</span> <span class="mf">4.</span>
    <span class="c"># evlist_bg_r = np.sqrt(rng.rand(n_events_bg * (tplt_multi + 1))) * r_max</span>
    <span class="n">rnd</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_events_bg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">tplt_multi</span><span class="p">))</span>
    <span class="n">evlist_bg_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span> <span class="o">*</span> <span class="n">evlist_bg_r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">random_state</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_events_bg</span> <span class="o">*</span> <span class="p">(</span><span class="n">tplt_multi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">evlist_bg_ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">rnd</span><span class="p">)</span> <span class="o">*</span> <span class="n">evlist_bg_r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">random_state</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_events_bg</span> <span class="o">*</span> <span class="p">(</span><span class="n">tplt_multi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>

    <span class="c"># evlist_bg_sky_r = np.sqrt(rng.rand(n_events_bg * (tplt_multi + 1))) * r_max</span>
    <span class="c"># evlist_bg_sky_r = ev_gen_f2(rng.rand(n_events_bg * (tplt_multi + 1)))</span>
    <span class="n">rnd</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_events_bg</span> <span class="o">*</span> <span class="p">(</span><span class="n">tplt_multi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">evlist_bg_ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rnd</span><span class="p">)</span> <span class="o">*</span> <span class="n">evlist_bg_r</span> <span class="o">/</span> <span class="n">objcosdec</span>
    <span class="n">evlist_bg_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rnd</span><span class="p">)</span> <span class="o">*</span> <span class="n">evlist_bg_r</span>

    <span class="c"># plt.hist(evlist_bg_rx ** 2. + evlist_bg_ry**2., bins=50)</span>

    <span class="c"># print float(n_events_bg * (tplt_multi + 1)) / np.sum(p_rate_area) / 86400.</span>
    <span class="n">evlist_bg_t</span> <span class="o">=</span> <span class="n">t_min</span> <span class="o">+</span> <span class="n">obstime</span> <span class="o">*</span> <span class="n">random_state</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_events_bg</span> <span class="o">*</span> <span class="p">(</span><span class="n">tplt_multi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mf">86400.</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Plots &amp; debug</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evlist_bg_dec</span><span class="p">,</span> <span class="n">evlist_dec</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evlist_bg_ra</span><span class="p">,</span> <span class="n">evlist_ra</span><span class="p">),</span>
        <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">objra</span> <span class="o">-</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">objra</span> <span class="o">+</span> <span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="n">objdec</span> <span class="o">-</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">objdec</span> <span class="o">+</span> <span class="mf">3.</span><span class="p">]]</span>
        <span class="p">)</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">yedges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xedges</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;Number of events&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;RA (deg)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Dec (deg)&#39;</span><span class="p">)</span>

    <span class="n">test_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">evlist_bg_ra</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">evlist_bg_dec</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Number of BG events in a circle of area 1 deg^2 = {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">test_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_events_bg</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Expected number of BG event per area 1 deg^2 = {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_rate_total</span> <span class="o">*</span> <span class="n">obstime</span><span class="p">))</span>

    <span class="n">obj_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">obj_ra</span> <span class="o">-</span> <span class="n">evlist_ra</span><span class="p">)</span> <span class="o">/</span> <span class="n">objcosdec</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">obj_dec</span> <span class="o">-</span> <span class="n">evlist_dec</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>

    <span class="n">thetamax_on</span><span class="p">,</span> <span class="n">thetamax_off</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">22</span>
    <span class="n">non</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obj_r</span> <span class="o">&lt;</span> <span class="n">thetamax_on</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">test_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_events_bg</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thetamax_on</span><span class="p">)</span>
    <span class="n">noff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">test_r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_events_bg</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thetamax_off</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">thetamax_on</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">thetamax_off</span> <span class="o">**</span> <span class="mf">2.</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;N_ON = {0}, N_OFF = {1}, ALPHA = {2}, SIGN = {3}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">non</span><span class="p">,</span> <span class="n">noff</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">significance_on_off</span><span class="p">(</span><span class="n">non</span><span class="p">,</span> <span class="n">noff</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">obj_r</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>


    <span class="n">dbase</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="s">&#39;2011-01-01 00:00:00&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s">&#39;utc&#39;</span><span class="p">)</span>
    <span class="n">dstart</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="s">&#39;2011-01-01 00:00:00&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s">&#39;utc&#39;</span><span class="p">)</span>
    <span class="n">dstop</span> <span class="o">=</span> <span class="n">dstart</span> <span class="o">+</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="n">obstime</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;sec&#39;</span><span class="p">)</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Output to file</span>

    <span class="k">if</span> <span class="n">output_filename_base</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Writing eventlist to file {0}.eventlist.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_filename_base</span><span class="p">))</span>

        <span class="n">newtable</span> <span class="o">=</span> <span class="n">np_to_evt</span><span class="p">(</span><span class="n">evlist_t</span><span class="p">,</span> <span class="n">evlist_bg_t</span><span class="p">,</span>
                             <span class="n">evlist_ra</span><span class="p">,</span> <span class="n">evlist_bg_ra</span><span class="p">,</span>
                             <span class="n">evlist_dec</span><span class="p">,</span> <span class="n">evlist_bg_dec</span><span class="p">,</span>
                             <span class="n">evlist_bg_rx</span><span class="p">,</span> <span class="n">evlist_bg_ry</span><span class="p">,</span>
                             <span class="n">evlist_e</span><span class="p">,</span> <span class="n">evlist_bg_e</span><span class="p">,</span>
                             <span class="n">pnt_ra</span><span class="p">,</span> <span class="n">pnt_dec</span><span class="p">,</span>
                             <span class="n">tplt_multi</span><span class="p">,</span> <span class="n">obstime</span><span class="p">,</span>
                             <span class="n">dstart</span><span class="o">=</span><span class="n">dstart</span><span class="p">,</span> <span class="n">dstop</span><span class="o">=</span><span class="n">dstop</span><span class="p">,</span> <span class="n">dbase</span><span class="o">=</span><span class="n">dbase</span><span class="p">)</span>
        <span class="c"># Write eventlist to file</span>
        <span class="n">newtable</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;{0}.eventlist.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_filename_base</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">write_pha</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Writing PHA to file {0}.pha.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_filename_base</span><span class="p">))</span>
            <span class="c"># Prepare data</span>
            <span class="n">dat</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="mf">10.</span> <span class="o">**</span> <span class="n">evlist_e</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edisp</span><span class="o">.</span><span class="n">energy_bounds</span><span class="p">(</span><span class="s">&#39;true&#39;</span><span class="p">))</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">dat_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span>
            <span class="c"># Data to PHA</span>
            <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">np_to_pha</span><span class="p">(</span><span class="n">counts</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">stat_err</span><span class="o">=</span><span class="n">dat_err</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">chan</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="n">obstime</span><span class="p">,</span>
                              <span class="n">obj_ra</span><span class="o">=</span><span class="n">obj_ra</span><span class="p">,</span> <span class="n">obj_dec</span><span class="o">=</span><span class="n">obj_dec</span><span class="p">,</span>
                              <span class="n">quality</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                              <span class="n">dstart</span><span class="o">=</span><span class="n">dstart</span><span class="p">,</span> <span class="n">dstop</span><span class="o">=</span><span class="n">dstop</span><span class="p">,</span> <span class="n">dbase</span><span class="o">=</span><span class="n">dbase</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="s">&#39;pfsim&#39;</span><span class="p">,</span>
                              <span class="n">telescope</span><span class="o">=</span><span class="s">&#39;CTASIM&#39;</span><span class="p">)</span>
            <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;ANCRFILE&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">arf</span><span class="p">),</span> <span class="s">&#39;Ancillary response file (ARF)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rmf</span><span class="p">:</span>
                <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;RESPFILE&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rmf</span><span class="p">),</span> <span class="s">&#39;Redistribution matrix file (RMF)&#39;</span><span class="p">)</span>

            <span class="c"># Write PHA to file</span>
            <span class="n">tbhdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s">&#39;{0}.pha.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_filename_base</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">do_graphical_output</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">np_to_evt</span><span class="p">(</span><span class="n">evlist_time</span><span class="p">,</span> <span class="n">evlist_bg_time</span><span class="p">,</span>
              <span class="n">evlist_ra</span><span class="p">,</span> <span class="n">evlist_bg_ra</span><span class="p">,</span>
              <span class="n">evlist_dec</span><span class="p">,</span> <span class="n">evlist_bg_dec</span><span class="p">,</span>
              <span class="n">evlist_bg_rx</span><span class="p">,</span> <span class="n">evlist_bg_ry</span><span class="p">,</span>
              <span class="n">evlist_energy</span><span class="p">,</span> <span class="n">evlist_bg_energy</span><span class="p">,</span>
              <span class="n">pnt_ra</span><span class="p">,</span> <span class="n">pnt_dec</span><span class="p">,</span>
              <span class="n">tplt_multi</span><span class="p">,</span> <span class="n">obstime</span><span class="p">,</span>
              <span class="n">dstart</span><span class="p">,</span> <span class="n">dstop</span><span class="p">,</span> <span class="n">dbase</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">stat_err</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">syserr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">obj_ra</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">obj_dec</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
              <span class="n">obj_name</span><span class="o">=</span><span class="s">&#39;DUMMY&#39;</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="s">&#39;DUMMY&#39;</span><span class="p">,</span>
              <span class="n">telescope</span><span class="o">=</span><span class="s">&#39;DUMMY&#39;</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="s">&#39;DUMMY&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="s">&#39;NONE&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create EVT FITS table extension from numpy arrays.</span>

<span class="sd">    TODO: document.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    TODO</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TODO</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_events</span><span class="p">,</span> <span class="n">n_events_bg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">evlist_time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">evlist_bg_time</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
    <span class="n">table</span><span class="p">[</span><span class="s">&#39;TIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evlist_time</span><span class="p">,</span> <span class="n">evlist_bg_time</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">),</span>
    <span class="n">table</span><span class="p">[</span><span class="s">&#39;RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evlist_ra</span><span class="p">,</span> <span class="n">evlist_bg_ra</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">),</span>
    <span class="n">table</span><span class="p">[</span><span class="s">&#39;DEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evlist_dec</span><span class="p">,</span> <span class="n">evlist_bg_dec</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">),</span>
    <span class="c"># Position source at position (DETX, DETY) = (0, 0.5)</span>
    <span class="n">table</span><span class="p">[</span><span class="s">&#39;DETX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_events</span><span class="p">),</span> <span class="n">evlist_bg_rx</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">),</span>
    <span class="n">table</span><span class="p">[</span><span class="s">&#39;DETY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_events</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">evlist_bg_ry</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">),</span>
    <span class="n">table</span><span class="p">[</span><span class="s">&#39;ENERGY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="mf">10.</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evlist_energy</span><span class="p">,</span> <span class="n">evlist_bg_energy</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s">&#39;tev&#39;</span><span class="p">),</span>
    <span class="n">hil_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_events</span> <span class="o">+</span> <span class="n">n_events_bg</span><span class="p">),</span> <span class="mf">5.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_events_bg</span> <span class="o">*</span> <span class="n">tplt_multi</span><span class="p">))</span>
    <span class="n">table</span><span class="p">[</span><span class="s">&#39;HIL_MSW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">hil_data</span><span class="p">)</span>
    <span class="n">table</span><span class="p">[</span><span class="s">&#39;HIL_MSL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">hil_data</span><span class="p">)</span>


    <span class="n">header</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">meta</span>

    <span class="n">header</span><span class="p">[</span><span class="s">&#39;RA_OBJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_ra</span><span class="p">,</span> <span class="s">&#39;Target position RA [deg]&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;DEC_OBJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_dec</span><span class="p">,</span> <span class="s">&#39;Target position dec [deg]&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;RA_PNT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnt_ra</span><span class="p">,</span> <span class="s">&#39;Observation position RA [deg]&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;DEC_PNT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnt_dec</span><span class="p">,</span> <span class="s">&#39;Observation position dec [deg]&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;EQUINOX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2000.0</span><span class="p">,</span> <span class="s">&#39;Equinox of the object&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;RADECSYS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;FK5&#39;</span><span class="p">,</span> <span class="s">&#39;Co-ordinate frame used for equinox&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CREATOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;gammapy v{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="s">&#39;Program&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">),</span> <span class="s">&#39;FITS file creation date (yyyy-mm-dd)&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TELESCOP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;CTASIM&#39;</span><span class="p">,</span> <span class="s">&#39;Instrument name&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;EXTNAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;EVENTS&#39;</span> <span class="p">,</span> <span class="s">&#39;HESARC standard&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE-OBS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dstart</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">),</span> <span class="s">&#39;Obs. start date (yy-mm-dd)&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TIME-OBS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dstart</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%H:%M:%S&#39;</span><span class="p">),</span> <span class="s">&#39;Obs. start time (hh:mm::ss)&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE-END&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dstop</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">),</span> <span class="s">&#39;Obs. stop date (yy-mm-dd)&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TIME-END&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dstop</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%H:%M:%S&#39;</span><span class="p">),</span> <span class="s">&#39;Obs. stop time (hh:mm::ss)&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TSTART&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="s">&#39;Mission time of start of obs [s]&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TSTOP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstime</span><span class="p">,</span> <span class="s">&#39;Mission time of end of obs [s]&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;MJDREFI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dstart</span><span class="o">.</span><span class="n">mjd</span><span class="p">),</span> <span class="s">&#39;Integer part of start MJD [s] &#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;MJDREFF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dstart</span><span class="o">.</span><span class="n">mjd</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">dstart</span><span class="o">.</span><span class="n">mjd</span><span class="p">),</span> <span class="s">&#39;Fractional part of start MJD&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TIMEUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;days&#39;</span> <span class="p">,</span> <span class="s">&#39;Time unit of MJD&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TIMESYS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;TT&#39;</span><span class="p">,</span> <span class="s">&#39;Terrestrial Time&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TIMEREF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;local&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TELAPSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstime</span><span class="p">,</span> <span class="s">&#39;Diff of start and end times&#39;</span>
    <span class="c"># Note: we are assuming deadtime = 0 here.</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;ONTIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstime</span><span class="p">,</span> <span class="s">&#39;Tot good time (incl deadtime)&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;LIVETIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstime</span><span class="p">,</span> <span class="s">&#39;Deadtime=ONTIME/LIVETIME&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;DEADC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="s">&#39;Deadtime fraction&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TIMEDEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="s">&#39;Time resolution&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;EUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;TeV&#39;</span><span class="p">,</span> <span class="s">&#39;Energy unit&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;EVTVER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;v1.0.0&#39;</span><span class="p">,</span> <span class="s">&#39;Event-list version number&#39;</span>

    <span class="k">return</span> <span class="n">table</span>


<div class="viewcode-block" id="skycircle_from_str"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.skycircle_from_str.html#gammapy.utils.pyfact.skycircle_from_str">[docs]</a><span class="k">def</span> <span class="nf">skycircle_from_str</span><span class="p">(</span><span class="n">cstr</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates SkyCircle from circle region string.&quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">cstr</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;CIRCLE&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">SkyCircle</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">r</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="get_cam_acc"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.get_cam_acc.html#gammapy.utils.pyfact.get_cam_acc">[docs]</a><span class="k">def</span> <span class="nf">get_cam_acc</span><span class="p">(</span><span class="n">camdist</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exreg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fitfunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the camera acceptance histogram from a given list with camera distances (event list).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    camdist : array</span>
<span class="sd">        Numpy array of camera distances (event list).</span>
<span class="sd">    rmax : float, optional</span>
<span class="sd">        Maximum radius for the acceptance histogram.</span>
<span class="sd">    nbins : int, optional</span>
<span class="sd">        Number of bins for the acceptance histogram (default = 0.1 deg).</span>
<span class="sd">    exreg : array, optional</span>
<span class="sd">        Array of exclusion regions. Exclusion regions are given by an aray of size 2</span>
<span class="sd">        [r, d] with r = radius, d = distance to camera center</span>
<span class="sd">    fit : bool, optional</span>
<span class="sd">        Fit acceptance histogram (default=False).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nbins</span><span class="p">:</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rmax</span> <span class="o">/</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>
    <span class="c"># Create camera distance histogram</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">camdist</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">rmax</span><span class="p">])</span>
    <span class="n">nerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="c"># Bin center array</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="c"># Bin area (ring) array</span>
    <span class="n">r_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="c"># Deal with exclusion regions</span>
    <span class="n">ex_a</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">exreg</span><span class="p">:</span>
        <span class="n">ex_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">exreg</span><span class="p">:</span>
            <span class="n">ex_a</span> <span class="o">+=</span> <span class="p">(</span><span class="n">circle_circle_intersection_array</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">t</span> <span class="o">*</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span> <span class="o">*</span> <span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                     <span class="o">-</span> <span class="n">circle_circle_intersection_array</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span> <span class="o">*</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span> <span class="o">*</span> <span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ex_a</span> <span class="o">/=</span> <span class="n">r_a</span>
    <span class="c"># Fit the data</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">fit</span><span class="p">:</span>
        <span class="c"># fitfunc = lambda p, x: p[0] * x ** p[1] * (1. + (x / p[2]) ** p[3]) ** ((p[1] + p[4]) / p[3])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fitfunc</span><span class="p">:</span>
            <span class="n">fitfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mf">0.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">**</span> <span class="p">((</span><span class="mf">0.</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="c"># fitfunc = lambda p, x: p[0] * x ** 0. * (1. + (x / p[1]) ** p[2]) ** ((0. + p[3]) / p[2]) + p[4] / (np.exp(p[5] * (x - p[6])) + 1.)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p0</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">r_a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.</span><span class="p">]</span>  <span class="c"># Initial guess for the parameters</span>
            <span class="c"># p0 = [.5 * n[0] / r_a[0], 1.5, 3., -5., .5 * n[0] / r_a[0], 100., .5] # Initial guess for the parameters</span>
        <span class="n">fitter</span> <span class="o">=</span> <span class="n">ChisquareFitter</span><span class="p">(</span><span class="n">fitfunc</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nerr</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_a</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ex_a</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Could not fit camera acceptance (dof={0}, bins={1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># ok, this _should_ be improved !!!</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="n">r_a</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ex_a</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="p">,</span> <span class="n">nerr</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="n">r_a</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ex_a</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">yerr</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">yerr</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Could not fit camera acceptance (dof={0}, bins={1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fitter</span><span class="o">.</span><span class="n">fit_data</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">yerr</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">nerr</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_a</span><span class="p">,</span> <span class="n">ex_a</span><span class="p">,</span> <span class="n">fitter</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="get_sky_mask_circle"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.get_sky_mask_circle.html#gammapy.utils.pyfact.get_sky_mask_circle">[docs]</a><span class="k">def</span> <span class="nf">get_sky_mask_circle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a 2d numpy histogram with (2. * r / bin_size) bins per axis</span>
<span class="sd">    where a circle of radius has bins filled 1.s, all other bins are 0.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r : float</span>
<span class="sd">        Radius of the circle.</span>
<span class="sd">    bin_size : float</span>
<span class="sd">        Physical size of the bin, same units as rmin, rmax.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sky_mask : 2d numpy array</span>
<span class="sd">        Returns a 2d numpy histogram with (2. * r / bin_size) bins per axis</span>
<span class="sd">        where a circle of radius has bins filled 1.s, all other bins are 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">))</span>
    <span class="n">sky_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nbins</span><span class="p">,</span> <span class="n">nbins</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">bin_size</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">r</span> <span class="o">-</span> <span class="n">bin_size</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">nbins</span><span class="p">)</span>
    <span class="n">sky_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sky_x</span><span class="p">)</span>
    <span class="n">sky_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sky_x</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">sky_y</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sky_mask</span>

</div>
<div class="viewcode-block" id="get_sky_mask_ring"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.get_sky_mask_ring.html#gammapy.utils.pyfact.get_sky_mask_ring">[docs]</a><span class="k">def</span> <span class="nf">get_sky_mask_ring</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a 2d numpy histogram with (2. * rmax / bin_size) bins per axis</span>
<span class="sd">    filled with a ring with inner radius rmin and outer radius rmax of 1.,</span>
<span class="sd">    all other bins are 0..</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rmin : float</span>
<span class="sd">        Inner radius of the ring.</span>
<span class="sd">    rmax : float</span>
<span class="sd">        Outer radius of the ring.</span>
<span class="sd">    bin_size : float</span>
<span class="sd">        Physical size of the bin, same units as rmin, rmax.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sky_mask : 2d numpy array</span>
<span class="sd">        Returns a 2d numpy histogram with (2. * rmax / bin_size) bins per axis</span>
<span class="sd">        filled with a ring with inner radius rmin and outer radius rmax of 1.,</span>
<span class="sd">        all other bins are 0..</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">rmax</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">))</span>
    <span class="n">sky_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nbins</span><span class="p">,</span> <span class="n">nbins</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">bin_size</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">rmax</span> <span class="o">-</span> <span class="n">bin_size</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">nbins</span><span class="p">)</span>
    <span class="n">sky_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sky_x</span><span class="p">)</span>
    <span class="n">sky_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sky_x</span> <span class="o">-</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">sky_y</span> <span class="o">-</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sky_x</span> <span class="o">-</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">sky_y</span> <span class="o">-</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">rmin</span><span class="p">),</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sky_mask</span>

</div>
<div class="viewcode-block" id="get_exclusion_region_map"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.get_exclusion_region_map.html#gammapy.utils.pyfact.get_exclusion_region_map">[docs]</a><span class="k">def</span> <span class="nf">get_exclusion_region_map</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">rarange</span><span class="p">,</span> <span class="n">decrange</span><span class="p">,</span> <span class="n">exreg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a map (2d numpy histogram) with all bins inside of exclusion regions set to 0. (others 1.).</span>

<span class="sd">    Dec is on the 1st axis (x), RA is on the 2nd (y).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    map : 2d array</span>
<span class="sd">    rarange : array</span>
<span class="sd">    decrange : array</span>
<span class="sd">    exreg : array-type of SkyCircle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xnbins</span><span class="p">,</span> <span class="n">ynbins</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">xstep</span><span class="p">,</span> <span class="n">ystep</span> <span class="o">=</span> <span class="p">(</span><span class="n">decrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">decrange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">xnbins</span><span class="p">),</span> <span class="p">(</span><span class="n">rarange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rarange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ynbins</span><span class="p">)</span>
    <span class="n">sky_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">xnbins</span><span class="p">,</span> <span class="n">ynbins</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">xval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">decrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">xstep</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">decrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xstep</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">xnbins</span><span class="p">))</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">yval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">rarange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ystep</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">rarange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ystep</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">ynbins</span><span class="p">))</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">exreg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reg</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">yval</span><span class="p">,</span> <span class="n">xval</span><span class="p">)):</span>
                    <span class="n">sky_mask</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">sky_mask</span>

</div>
<div class="viewcode-block" id="oversample_sky_map"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.oversample_sky_map.html#gammapy.utils.pyfact.oversample_sky_map">[docs]</a><span class="k">def</span> <span class="nf">oversample_sky_map</span><span class="p">(</span><span class="n">sky</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">exmap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Oversamples a 2d numpy histogram with a given mask.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sky : 2d array</span>
<span class="sd">    mask : 2d array</span>
<span class="sd">    exmap : 2d array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">convolve</span>
    <span class="n">sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sky</span><span class="p">)</span>

    <span class="n">sky_nx</span><span class="p">,</span> <span class="n">sky_ny</span> <span class="o">=</span> <span class="n">sky</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sky</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mask_nx</span><span class="p">,</span> <span class="n">mask_ny</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mask_centerx</span><span class="p">,</span> <span class="n">mask_centery</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">mask_ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c"># new oversampled sky plot</span>
    <span class="n">sky_overs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sky_nx</span><span class="p">,</span> <span class="n">sky_ny</span><span class="p">))</span>

    <span class="c"># 2d hist keeping the number of bins used (alpha)</span>
    <span class="n">sky_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">sky_nx</span><span class="p">,</span> <span class="n">sky_ny</span><span class="p">))</span>

    <span class="n">sky_base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">sky_nx</span><span class="p">,</span> <span class="n">sky_ny</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">exmap</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">sky</span> <span class="o">*=</span> <span class="n">exmap</span>
        <span class="n">sky_base</span> <span class="o">*=</span> <span class="n">exmap</span>

    <span class="n">convolve</span><span class="p">(</span><span class="n">sky</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">sky_overs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">convolve</span><span class="p">(</span><span class="n">sky_base</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">sky_alpha</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;constant&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">sky_overs</span><span class="p">,</span> <span class="n">sky_alpha</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="create_sky_map"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.create_sky_map.html#gammapy.utils.pyfact.create_sky_map">[docs]</a><span class="k">def</span> <span class="nf">create_sky_map</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">,</span>
                   <span class="n">skymap_size</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
                   <span class="n">skymap_bin_size</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                   <span class="n">r_overs</span><span class="o">=.</span><span class="mi">125</span><span class="p">,</span>
                   <span class="n">ring_bg_radii</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">template_background</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">skymap_center</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">write_output</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">fov_acceptance</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">do_graphical_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">loglevel</span><span class="o">=</span><span class="s">&#39;INFO&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create sky map.</span>

<span class="sd">    TODO: describe</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    TODO</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TODO</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">UnivariateSpline</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Loop over the file list, calculate quantities, &amp; fill histograms</span>

    <span class="c"># Skymap definition</span>
    <span class="c"># skymap_size, skymap_bin_size = 6., 0.05</span>
    <span class="n">rexdeg</span> <span class="o">=</span> <span class="o">.</span><span class="mi">3</span>

    <span class="c"># Intialize some variables</span>
    <span class="n">skycenra</span><span class="p">,</span> <span class="n">skycendec</span><span class="p">,</span> <span class="n">pntra</span><span class="p">,</span> <span class="n">pntdec</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">skymap_center</span><span class="p">:</span>
        <span class="n">skycenra</span><span class="p">,</span> <span class="n">skycendec</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">skymap_center</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Skymap center: RA {0}, Dec {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">skycenra</span><span class="p">,</span> <span class="n">skycendec</span><span class="p">))</span>

    <span class="n">ring_bg_r_min</span><span class="p">,</span> <span class="n">ring_bg_r_max</span> <span class="o">=</span> <span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="o">.</span><span class="mi">7</span>
    <span class="k">if</span> <span class="n">ring_bg_radii</span><span class="p">:</span>
        <span class="n">ring_bg_r_min</span><span class="p">,</span> <span class="n">ring_bg_r_max</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ring_bg_radii</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">r_overs</span> <span class="o">&gt;</span> <span class="n">ring_bg_r_min</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Oversampling radius is larger than the inner radius chosen for the ring BG: {0} &gt; {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r_overs</span><span class="p">,</span> <span class="n">ring_bg_r_min</span><span class="p">))</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Skymap size         : {0} deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">skymap_size</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Skymap bin size     : {0} deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">skymap_bin_size</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Oversampling radius : {0} deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r_overs</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Ring BG radius      : {0} - {1} deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ring_bg_r_min</span><span class="p">,</span> <span class="n">ring_bg_r_max</span><span class="p">))</span>

    <span class="n">skymap_nbins</span><span class="p">,</span> <span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">,</span> <span class="n">objcosdec</span><span class="p">,</span> <span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
    <span class="n">sky_hist</span><span class="p">,</span> <span class="n">acc_hist</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="n">tpl_had_hist</span><span class="p">,</span> <span class="n">tpl_acc_hist</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="n">sky_ex_reg</span><span class="p">,</span> <span class="n">sky_ex_reg_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="n">telescope</span><span class="p">,</span> <span class="n">object_</span> <span class="o">=</span> <span class="s">&#39;NONE&#39;</span><span class="p">,</span> <span class="s">&#39;NONE&#39;</span>

    <span class="n">firstloop</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">exposure</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c"># Read in input file, can be individual fits or bankfile</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Opening input file ..&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_filelist</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">)</span> <span class="p">:</span>
        <span class="c"># Check if we are dealing with a single file or a bankfile</span>
        <span class="c"># and create/read in the file list accordingly</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_file_name</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># We are dealing with a bankfile</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Reading files from bankfile {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">))</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;S&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">file_list</span>

    <span class="n">file_list</span> <span class="o">=</span> <span class="n">get_filelist</span><span class="p">(</span><span class="n">input_file_name</span><span class="p">)</span>

    <span class="n">tpl_file_list</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Read in template files</span>
    <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
        <span class="n">tpl_file_list</span> <span class="o">=</span> <span class="n">get_filelist</span><span class="p">(</span><span class="n">template_background</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tpl_file_list</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Different number of signal and template background files. &#39;</span>
                            <span class="s">&#39;Switching off template background analysis.&#39;</span><span class="p">)</span>
            <span class="n">template_background</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Main loop over input files</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Processing file {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">get_evl</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
            <span class="c"># Open fits file</span>
            <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="c"># Access header of second extension</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s">&#39;EVENTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="c"># Access data of first extension</span>
            <span class="n">tbdata</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s">&#39;EVENTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="c"># Calculate some useful quantities and add them to the table</span>
            <span class="c"># Distance from the camera (FOV) center</span>
            <span class="n">camdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DETX&#39;</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DETY&#39;</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>
            <span class="n">camdist_col</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;XCAMDIST&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;1E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">camdist</span><span class="p">)</span>
            <span class="c"># Add new columns to the table</span>
            <span class="n">coldefs_new</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">([</span><span class="n">camdist_col</span><span class="p">])</span>
            <span class="c"># coldefs_new = fits.ColDefs([camdist_col, detx_col, dety_col])</span>
            <span class="n">newtable</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="n">coldefs_new</span><span class="p">)</span>
            <span class="c"># New table data</span>
            <span class="k">return</span> <span class="n">hdulist</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">newtable</span><span class="o">.</span><span class="n">data</span>

        <span class="n">hdulist</span><span class="p">,</span> <span class="n">ex1hdr</span><span class="p">,</span> <span class="n">tbdata</span> <span class="o">=</span> <span class="n">get_evl</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="c"># Read in eventlist for template background</span>
        <span class="n">tpl_hdulist</span><span class="p">,</span> <span class="n">tpl_tbdata</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
            <span class="n">tpl_hdulist</span><span class="p">,</span> <span class="n">tpl_hdr</span><span class="p">,</span> <span class="n">tpl_tbdata</span> <span class="o">=</span> <span class="n">get_evl</span><span class="p">(</span><span class="n">tpl_file_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c">#---------------------------------------------------------------------------</span>
        <span class="c"># Intialize &amp; GTI</span>

        <span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span> <span class="o">=</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;RA_OBJ&#39;</span><span class="p">],</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;DEC_OBJ&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">firstloop</span><span class="p">:</span>
            <span class="c"># If skymap center is not set, set it to the object position of the first run</span>
            <span class="k">if</span> <span class="n">skycenra</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">skycendec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">skycenra</span><span class="p">,</span> <span class="n">skycendec</span> <span class="o">=</span> <span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Setting skymap center to skycenra, skycendec = {0}, {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">skycenra</span><span class="p">,</span> <span class="n">skycendec</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&#39;TELESCOP&#39;</span> <span class="ow">in</span> <span class="n">ex1hdr</span><span class="p">:</span>
                <span class="n">telescope</span> <span class="o">=</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;TELESCOP&#39;</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Setting TELESCOP to {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">telescope</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&#39;OBJECT&#39;</span> <span class="ow">in</span> <span class="n">ex1hdr</span><span class="p">:</span>
                <span class="n">object_</span> <span class="o">=</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;OBJECT&#39;</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Setting OBJECT to {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">object_</span><span class="p">))</span>

        <span class="n">mgit</span><span class="p">,</span> <span class="n">tpl_mgit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbdata</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
            <span class="n">tpl_mgit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tpl_tbdata</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Note: according to the eventlist format document v1.0.0 Section 10</span>
            <span class="c"># &quot;The times are expressed in the same units as in the EVENTS</span>
            <span class="c"># table (seconds since mission start in terresterial time).&quot;</span>
            <span class="k">for</span> <span class="n">gti</span> <span class="ow">in</span> <span class="n">hdulist</span><span class="p">[</span><span class="s">&#39;GTI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">mgit</span> <span class="o">*=</span> <span class="p">(</span><span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;TIME&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">gti</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;TIME&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">gti</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
                    <span class="n">tpl_mgit</span> <span class="o">*=</span> <span class="p">(</span><span class="n">tpl_tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;TIME&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">gti</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">tpl_tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;TIME&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">gti</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;File does not contain a GTI extension&#39;</span><span class="p">)</span>

        <span class="c">#---------------------------------------------------------------------------</span>
        <span class="c">#  Handle exclusion region</span>

        <span class="c"># If no exclusion regions are given, use the object position from the first run</span>
        <span class="k">if</span> <span class="n">sky_ex_reg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sky_ex_reg</span> <span class="o">=</span> <span class="p">[</span><span class="n">SkyCircle</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span><span class="p">),</span> <span class="n">rexdeg</span><span class="p">)]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Setting exclusion region to object position (ra={0}, dec={1}, r={2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span><span class="p">,</span> <span class="n">rexdeg</span><span class="p">))</span>

        <span class="n">pntra</span><span class="p">,</span> <span class="n">pntdec</span> <span class="o">=</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;RA_PNT&#39;</span><span class="p">],</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;DEC_PNT&#39;</span><span class="p">]</span>
        <span class="n">obj_cam_dist</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">skycenra</span><span class="p">,</span> <span class="n">skycendec</span><span class="p">)</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">pntra</span><span class="p">,</span> <span class="n">pntdec</span><span class="p">))</span>

        <span class="n">exposure_run</span> <span class="o">=</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;LIVETIME&#39;</span><span class="p">]</span>
        <span class="n">exposure</span> <span class="o">+=</span> <span class="n">exposure_run</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Start date/time : {0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;DATE_OBS&#39;</span><span class="p">],</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;TIME_OBS&#39;</span><span class="p">]))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Stop date/time  : {0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;DATE_END&#39;</span><span class="p">],</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;TIME_END&#39;</span><span class="p">]))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Exposure        : {0:.2f} [s]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exposure_run</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Pointing pos.   : RA {0:.4f} [deg], Dec {1:.4f} [deg]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pntra</span><span class="p">,</span> <span class="n">pntdec</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Obj. cam. dist. : {0:.4f} [deg]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj_cam_dist</span><span class="p">))</span>

        <span class="c"># Cut out source region for acceptance fitting</span>
        <span class="n">exmask</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">sky_ex_reg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exmask</span><span class="p">:</span>
                <span class="n">exmask</span> <span class="o">*=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;RA&#39;</span><span class="p">),</span> <span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DEC&#39;</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exmask</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;RA&#39;</span><span class="p">),</span> <span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DEC&#39;</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">r</span>
        <span class="n">exmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">exmask</span><span class="p">)</span>

        <span class="n">photbdata</span> <span class="o">=</span> <span class="n">tbdata</span><span class="p">[</span><span class="n">exmask</span> <span class="o">*</span> <span class="n">mgit</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">photbdata</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Less then 10 events found in file {0} after exclusion region cuts&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>

        <span class="n">hadtbdata</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
            <span class="n">exmask</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">sky_ex_reg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exmask</span><span class="p">:</span>
                    <span class="n">exmask</span> <span class="o">*=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">tpl_tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;RA&#39;</span><span class="p">),</span> <span class="n">tpl_tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DEC&#39;</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">r</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exmask</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">tpl_tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;RA&#39;</span><span class="p">),</span> <span class="n">tpl_tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DEC&#39;</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">r</span>
            <span class="n">exmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">exmask</span><span class="p">)</span>
            <span class="n">hadtbdata</span> <span class="o">=</span> <span class="n">tpl_tbdata</span><span class="p">[</span><span class="n">exmask</span> <span class="o">*</span> <span class="n">tpl_mgit</span><span class="p">]</span>

        <span class="c">#---------------------------------------------------------------------------</span>
        <span class="c"># Calculate camera acceptance</span>

        <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">nerr</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_a</span><span class="p">,</span> <span class="n">ex_a</span><span class="p">,</span> <span class="n">fitter</span> <span class="o">=</span> <span class="n">get_cam_acc</span><span class="p">(</span>
            <span class="n">photbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XCAMDIST&#39;</span><span class="p">),</span>
            <span class="n">exreg</span><span class="o">=</span><span class="p">[(</span><span class="n">sc</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">pntra</span><span class="p">,</span> <span class="n">pntdec</span><span class="p">)))</span> <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">sky_ex_reg</span><span class="p">],</span>
            <span class="n">fit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c"># DEBUG</span>
        <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">fitter</span><span class="o">.</span><span class="n">print_results</span><span class="p">()</span>
            <span class="c"># DEBUG plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span> <span class="o">/</span> <span class="n">r_a</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ex_a</span><span class="p">),</span> <span class="n">nerr</span> <span class="o">/</span> <span class="n">r_a</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ex_a</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">fitter</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">had_acc</span><span class="p">,</span> <span class="n">had_n</span><span class="p">,</span> <span class="n">had_fit</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
            <span class="n">had_acc</span> <span class="o">=</span> <span class="n">get_cam_acc</span><span class="p">(</span>
                <span class="n">hadtbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XCAMDIST&#39;</span><span class="p">),</span>
                <span class="n">exreg</span><span class="o">=</span><span class="p">[(</span><span class="n">sc</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">pntra</span><span class="p">,</span> <span class="n">pntdec</span><span class="p">)))</span> <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">sky_ex_reg</span><span class="p">],</span>
                <span class="n">fit</span><span class="o">=</span><span class="bp">True</span>
                <span class="p">)</span>
            <span class="n">had_n</span><span class="p">,</span> <span class="n">had_fit</span> <span class="o">=</span> <span class="n">had_acc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">had_acc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Camera acceptance hadrons fit probability: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">had_fit</span><span class="o">.</span><span class="n">prob</span><span class="p">))</span>

        <span class="c"># !!! All photons including the exclusion regions</span>
        <span class="n">photbdata</span> <span class="o">=</span> <span class="n">tbdata</span><span class="p">[</span><span class="n">mgit</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
            <span class="n">hadtbdata</span> <span class="o">=</span> <span class="n">tpl_tbdata</span><span class="p">[</span><span class="n">tpl_mgit</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">photbdata</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Less then 10 events found in file {0} after GTI cut.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>

        <span class="n">tpl_acc_cor_use_interp</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">tpl_acc_f</span><span class="p">,</span> <span class="n">tpl_acc</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tpl_acc_cor_use_interp</span><span class="p">:</span>
                <span class="n">tpl_acc_f</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">had_n</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tpl_acc_f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">had_fit</span><span class="o">.</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">had_fit</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">tpl_acc</span> <span class="o">=</span> <span class="n">tpl_acc_f</span><span class="p">(</span><span class="n">hadtbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XCAMDIST&#39;</span><span class="p">))</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">hadtbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XCAMDIST&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tpl_acc</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_acc_f</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">hadtbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XCAMDIST&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tpl_acc</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_acc_f</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c">#---------------------------------------------------------------------------</span>
        <span class="c"># Skymap - definitions/calculation</span>

        <span class="c"># Object position in the sky</span>
        <span class="k">if</span> <span class="n">firstloop</span><span class="p">:</span>
            <span class="c"># skycenra, objdec, skymap_size = ex1hdr[&#39;RA_OBJ&#39;], ex1hdr[&#39;DEC_OBJ&#39;], 6.</span>
            <span class="c"># if skycenra is None or objdec is None:</span>
            <span class="c">#    skycenra, objdec = ex1hdr[&#39;RA_OBJ&#39;], ex1hdr[&#39;DEC_OBJ&#39;]</span>

            <span class="c"># Calculate skymap limits</span>
            <span class="n">skymap_nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">skymap_size</span> <span class="o">/</span> <span class="n">skymap_bin_size</span><span class="p">)</span>
            <span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span> <span class="o">=</span> <span class="n">skycendec</span> <span class="o">-</span> <span class="n">skymap_size</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">skycendec</span> <span class="o">+</span> <span class="n">skymap_size</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">objcosdec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">skycendec</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span>
            <span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span> <span class="o">=</span> <span class="n">skycenra</span> <span class="o">-</span> <span class="n">skymap_size</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">objcosdec</span><span class="p">,</span> <span class="n">skycenra</span> <span class="o">+</span> <span class="n">skymap_size</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">objcosdec</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;skymap_nbins = {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">skymap_nbins</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;sky_dec_min, sky_dec_max = {0}, {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;sky_ra_min, sky_ra_max = {0}, {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">))</span>

        <span class="c"># Create sky map (i.e. bin events)</span>
        <span class="c"># NOTE: In histogram2d the first axes is the vertical (y, DEC) the 2nd the horizontal axes (x, RA)</span>
        <span class="n">sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">photbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DEC     &#39;</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">photbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;RA      &#39;</span><span class="p">),</span>
                             <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">skymap_nbins</span><span class="p">,</span> <span class="n">skymap_nbins</span><span class="p">],</span>
                             <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">],</span> <span class="p">[</span><span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">]])</span>

        <span class="k">if</span> <span class="n">firstloop</span><span class="p">:</span>
            <span class="c"># Just used to have the x-min/max, y-min/max saved</span>
            <span class="n">H</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">sky</span>
            <span class="c"># NOTE: The zero point of the histogram 2d is at the lower left corner while</span>
            <span class="c">#       the pyplot routine imshow takes [0,0] at the upper left corner (i.e.</span>
            <span class="c">#       we have to invert the 1st axis before plotting, see below).</span>
            <span class="c">#       Also, imshow uses the traditional 1st axes = x = RA, 2nd axes = y = DEC</span>
            <span class="c">#       notation for the extend keyword</span>
            <span class="c"># extent = [yedges[0], yedges[-1], xedges[-1], xedges[0]]</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">yedges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xedges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">sky_hist</span> <span class="o">=</span> <span class="n">sky</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">sky_ex_reg_map</span> <span class="o">=</span> <span class="n">get_exclusion_region_map</span><span class="p">(</span><span class="n">sky_hist</span><span class="p">,</span>
                                                         <span class="p">(</span><span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">),</span>
                                                         <span class="p">(</span><span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">),</span>
                                                         <span class="n">sky_ex_reg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sky_hist</span> <span class="o">+=</span> <span class="n">sky</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Calculate camera acceptance</span>
        <span class="n">dec_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">,</span> <span class="n">skymap_nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ra_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">,</span> <span class="n">skymap_nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">((</span><span class="n">ra_a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ra_a</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">pntra</span><span class="p">,</span> <span class="p">(</span><span class="n">dec_a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dec_a</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">pntdec</span><span class="p">)</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xx</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">yy</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">rr</span><span class="p">)</span> <span class="o">/</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="o">.</span><span class="mo">01</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">&gt;</span> <span class="mf">4.</span>
        <span class="n">acc</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="mf">4.</span><span class="p">)</span> <span class="o">/</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="o">.</span><span class="mo">01</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fov_acceptance</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Do _not_ apply FoV acceptance correction&#39;</span><span class="p">)</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">*</span> <span class="mf">0.</span> <span class="o">+</span> <span class="mf">1.</span>

        <span class="c"># DEBUG plot</span>
        <span class="c"># plt.imshow(acc[::-1], extent=extent, interpolation=&#39;nearest&#39;)</span>
        <span class="c"># plt.colorbar()</span>
        <span class="c"># plt.title(&#39;acc_bg_overs&#39;)</span>
        <span class="c"># plt.show()</span>

        <span class="k">if</span> <span class="n">firstloop</span><span class="p">:</span>
            <span class="n">acc_hist</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">*</span> <span class="n">exposure_run</span>  <span class="c"># acc[0] before</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acc_hist</span> <span class="o">+=</span> <span class="n">acc</span> <span class="o">*</span> <span class="n">exposure_run</span>  <span class="c"># acc[0] before</span>

        <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
            <span class="c"># Create hadron event like map for template background</span>
            <span class="n">tpl_had</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">hadtbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DEC     &#39;</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">hadtbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;RA      &#39;</span><span class="p">),</span>
                                     <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">skymap_nbins</span><span class="p">,</span> <span class="n">skymap_nbins</span><span class="p">],</span>
                                     <span class="c"># weights=1./accept,</span>
                                     <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">],</span> <span class="p">[</span><span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">firstloop</span><span class="p">:</span>
                <span class="n">tpl_had_hist</span> <span class="o">=</span> <span class="n">tpl_had</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tpl_had_hist</span> <span class="o">+=</span> <span class="n">tpl_had</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c"># Create acceptance map for template background</span>
            <span class="n">tpl_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">hadtbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DEC     &#39;</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">hadtbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;RA      &#39;</span><span class="p">),</span>
                                     <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">skymap_nbins</span><span class="p">,</span> <span class="n">skymap_nbins</span><span class="p">],</span>
                                     <span class="n">weights</span><span class="o">=</span><span class="n">tpl_acc</span><span class="p">,</span>
                                     <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">],</span> <span class="p">[</span><span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">firstloop</span><span class="p">:</span>
                <span class="n">tpl_acc_hist</span> <span class="o">=</span> <span class="n">tpl_acc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tpl_acc_hist</span> <span class="o">+=</span> <span class="n">tpl_acc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Close fits file</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tpl_hdulist</span><span class="p">:</span>
            <span class="n">tpl_hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Clean up memory</span>
        <span class="n">newtable</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># TODO: this shouldn&#39;t be necessary any more.</span>
        <span class="c"># This was an issue with old versions of pyfits.</span>
        <span class="c"># Remove and test that memory is not leaked.</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="n">firstloop</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Calculate final skymaps</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Processing final sky maps&#39;</span><span class="p">)</span>

    <span class="c"># Calculate oversampled skymap, ring background, excess, and significances</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">get_sky_mask_circle</span><span class="p">(</span><span class="n">r_overs</span><span class="p">,</span> <span class="n">skymap_bin_size</span><span class="p">)</span>
    <span class="n">sr</span> <span class="o">=</span> <span class="n">get_sky_mask_ring</span><span class="p">(</span><span class="n">ring_bg_r_min</span><span class="p">,</span> <span class="n">ring_bg_r_max</span><span class="p">,</span> <span class="n">skymap_bin_size</span><span class="p">)</span>
    <span class="n">acc_hist</span> <span class="o">/=</span> <span class="n">exposure</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Calculating oversampled event map ..&#39;</span><span class="p">)</span>
    <span class="n">sky_overs</span><span class="p">,</span> <span class="n">sky_overs_alpha</span> <span class="o">=</span> <span class="n">oversample_sky_map</span><span class="p">(</span><span class="n">sky_hist</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Calculating oversampled ring background map ..&#39;</span><span class="p">)</span>
    <span class="n">sky_bg_ring</span><span class="p">,</span> <span class="n">sky_bg_ring_alpha</span> <span class="o">=</span> <span class="n">oversample_sky_map</span><span class="p">(</span><span class="n">sky_hist</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">sky_ex_reg_map</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Calculating oversampled event acceptance map ..&#39;</span><span class="p">)</span>
    <span class="n">acc_overs</span><span class="p">,</span> <span class="n">acc_overs_alpha</span> <span class="o">=</span> <span class="n">oversample_sky_map</span><span class="p">(</span><span class="n">acc_hist</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Calculating oversampled ring background acceptance map ..&#39;</span><span class="p">)</span>
    <span class="n">acc_bg_overs</span><span class="p">,</span> <span class="n">acc_bg_overs_alpha</span> <span class="o">=</span> <span class="n">oversample_sky_map</span><span class="p">(</span><span class="n">acc_hist</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">sky_ex_reg_map</span><span class="p">)</span>


    <span class="n">rng_alpha</span> <span class="o">=</span> <span class="n">acc_hist</span> <span class="o">/</span> <span class="n">acc_bg_overs</span>  <span class="c"># camera acceptance</span>
    <span class="n">rng_exc</span> <span class="o">=</span> <span class="n">sky_hist</span> <span class="o">-</span> <span class="n">sky_bg_ring</span> <span class="o">*</span> <span class="n">rng_alpha</span>
    <span class="n">rng_sig</span> <span class="o">=</span> <span class="n">significance_on_off</span><span class="p">(</span><span class="n">sky_hist</span><span class="p">,</span> <span class="n">sky_bg_ring</span><span class="p">,</span> <span class="n">rng_alpha</span><span class="p">)</span>

    <span class="n">rng_alpha_overs</span> <span class="o">=</span> <span class="n">acc_overs</span> <span class="o">/</span> <span class="n">acc_bg_overs</span>  <span class="c"># camera acceptance</span>
    <span class="n">rng_exc_overs</span> <span class="o">=</span> <span class="n">sky_overs</span> <span class="o">-</span> <span class="n">sky_bg_ring</span> <span class="o">*</span> <span class="n">rng_alpha_overs</span>
    <span class="n">rng_sig_overs</span> <span class="o">=</span> <span class="n">significance_on_off</span><span class="p">(</span><span class="n">sky_overs</span><span class="p">,</span> <span class="n">sky_bg_ring</span><span class="p">,</span> <span class="n">rng_alpha_overs</span><span class="p">)</span>

    <span class="n">tpl_had_overs</span><span class="p">,</span> <span class="n">tpl_sig_overs</span><span class="p">,</span> <span class="n">tpl_exc_overs</span><span class="p">,</span> <span class="n">tpl_alpha_overs</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Calculating oversampled template background map ..&#39;</span><span class="p">)</span>
        <span class="n">tpl_had_overs</span><span class="p">,</span> <span class="n">tpl_had_overs_alpha</span> <span class="o">=</span> <span class="n">oversample_sky_map</span><span class="p">(</span><span class="n">tpl_had_hist</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Calculating oversampled template acceptance map ..&#39;</span><span class="p">)</span>
        <span class="n">tpl_acc_overs</span><span class="p">,</span> <span class="n">tpl_acc_overs_alpha</span> <span class="o">=</span> <span class="n">oversample_sky_map</span><span class="p">(</span><span class="n">tpl_acc_hist</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>

        <span class="n">tpl_exc_overs</span> <span class="o">=</span> <span class="n">sky_overs</span> <span class="o">-</span> <span class="n">tpl_acc_overs</span>
        <span class="n">tpl_alpha_overs</span> <span class="o">=</span> <span class="n">tpl_acc_overs</span> <span class="o">/</span> <span class="n">tpl_had_overs</span>
        <span class="n">tpl_sig_overs</span> <span class="o">=</span> <span class="n">significance_on_off</span><span class="p">(</span><span class="n">sky_overs</span><span class="p">,</span> <span class="n">tpl_had_overs</span><span class="p">,</span> <span class="n">tpl_alpha_overs</span><span class="p">)</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Write results to file</span>

    <span class="k">if</span> <span class="n">write_output</span><span class="p">:</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Writing result to file ..&#39;</span><span class="p">)</span>

        <span class="n">rarange</span><span class="p">,</span> <span class="n">decrange</span> <span class="o">=</span> <span class="p">(</span><span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">),</span> <span class="p">(</span><span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">)</span>

        <span class="n">outfile_base_name</span> <span class="o">=</span> <span class="s">&#39;skymap_ring&#39;</span>
        <span class="n">outfile_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;_ev.fits&#39;</span><span class="p">:</span> <span class="n">sky_hist</span><span class="p">,</span>
            <span class="s">&#39;_ac.fits&#39;</span><span class="p">:</span> <span class="n">acc_hist</span><span class="p">,</span>
            <span class="s">&#39;_ev_overs.fits&#39;</span><span class="p">:</span> <span class="n">sky_overs</span><span class="p">,</span>
            <span class="s">&#39;_bg_overs.fits&#39;</span><span class="p">:</span> <span class="n">sky_bg_ring</span><span class="p">,</span>
            <span class="s">&#39;_si_overs.fits&#39;</span><span class="p">:</span> <span class="n">rng_sig_overs</span><span class="p">,</span>
            <span class="s">&#39;_ex_overs.fits&#39;</span><span class="p">:</span> <span class="n">rng_exc_overs</span><span class="p">,</span>
            <span class="s">&#39;_al_overs.fits&#39;</span><span class="p">:</span> <span class="n">rng_alpha_overs</span><span class="p">,</span>
            <span class="s">&#39;_si.fits&#39;</span><span class="p">:</span> <span class="n">rng_sig</span><span class="p">,</span>
            <span class="s">&#39;_ex.fits&#39;</span><span class="p">:</span> <span class="n">rng_exc</span><span class="p">,</span>
            <span class="s">&#39;_al.fits&#39;</span><span class="p">:</span> <span class="n">rng_alpha</span>
            <span class="p">}</span>
        <span class="n">outfile_base_name</span> <span class="o">=</span> <span class="n">unique_base_file_name</span><span class="p">(</span><span class="n">outfile_base_name</span><span class="p">,</span> <span class="n">outfile_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">outfile_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">image_to_primaryhdu</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rarange</span><span class="p">,</span> <span class="n">decrange</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s">&#39;PyFACT pfmap&#39;</span><span class="p">,</span>
                                 <span class="n">object_</span><span class="o">=</span><span class="n">object_</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="n">telescope</span><span class="p">)</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile_base_name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
            <span class="n">outfile_base_name</span> <span class="o">=</span> <span class="s">&#39;skymap_template&#39;</span>
            <span class="n">outfile_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;_bg.fits&#39;</span><span class="p">:</span> <span class="n">tpl_had_hist</span><span class="p">,</span>
                <span class="s">&#39;_ac.fits&#39;</span><span class="p">:</span> <span class="n">tpl_acc_hist</span><span class="p">,</span>
                <span class="s">&#39;_bg_overs.fits&#39;</span><span class="p">:</span> <span class="n">tpl_had_overs</span><span class="p">,</span>
                <span class="s">&#39;_si_overs.fits&#39;</span><span class="p">:</span> <span class="n">tpl_sig_overs</span><span class="p">,</span>
                <span class="s">&#39;_ex_overs.fits&#39;</span><span class="p">:</span> <span class="n">tpl_exc_overs</span><span class="p">,</span>
                <span class="s">&#39;_al_overs.fits&#39;</span><span class="p">:</span> <span class="n">tpl_alpha_overs</span><span class="p">,</span>
                <span class="c"># &#39;_si.fits&#39;: rng_sig,</span>
                <span class="c"># &#39;_ex.fits&#39;: rng_exc,</span>
                <span class="c"># &#39;_al.fits&#39;: rng_alpha</span>
                <span class="p">}</span>
            <span class="n">outfile_base_name</span> <span class="o">=</span> <span class="n">unique_base_file_name</span><span class="p">(</span><span class="n">outfile_base_name</span><span class="p">,</span> <span class="n">outfile_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">outfile_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">image_to_primaryhdu</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rarange</span><span class="p">,</span> <span class="n">decrange</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s">&#39;PyFACT pfmap&#39;</span><span class="p">,</span>
                                     <span class="n">object_</span><span class="o">=</span><span class="n">object_</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="n">telescope</span><span class="p">)</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile_base_name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;The output files can be found in {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Plot results</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="n">has_matplotlib</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">has_matplotlib</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">has_matplotlib</span> <span class="ow">and</span> <span class="n">do_graphical_output</span><span class="p">:</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Plotting results (matplotlib v{0})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>

        <span class="n">plot_skymaps</span><span class="p">(</span><span class="n">sky_overs</span><span class="p">,</span> <span class="n">rng_exc_overs</span><span class="p">,</span> <span class="n">rng_sig_overs</span><span class="p">,</span> <span class="n">sky_bg_ring</span><span class="p">,</span> <span class="n">rng_alpha_overs</span><span class="p">,</span> <span class="s">&#39;Ring BG overs.&#39;</span><span class="p">,</span>
                     <span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">,</span> <span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">,</span> <span class="n">objcosdec</span><span class="p">,</span> <span class="n">r_overs</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span>
                     <span class="n">skycenra</span><span class="p">,</span> <span class="n">skycendec</span><span class="p">,</span> <span class="n">ring_bg_r_min</span><span class="p">,</span> <span class="n">ring_bg_r_max</span><span class="p">,</span> <span class="n">sign_hist_r_max</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">template_background</span><span class="p">:</span>
            <span class="n">plot_skymaps</span><span class="p">(</span><span class="n">sky_overs</span><span class="p">,</span> <span class="n">tpl_exc_overs</span><span class="p">,</span> <span class="n">tpl_sig_overs</span><span class="p">,</span> <span class="n">tpl_had_overs</span><span class="p">,</span> <span class="n">tpl_alpha_overs</span><span class="p">,</span>
                         <span class="s">&#39;Template BG overs.&#39;</span><span class="p">,</span>
                         <span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">,</span> <span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">,</span> <span class="n">objcosdec</span><span class="p">,</span> <span class="n">r_overs</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span>
                         <span class="n">skycenra</span><span class="p">,</span> <span class="n">skycendec</span><span class="p">,</span> <span class="n">sign_hist_r_max</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="plot_skymaps"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.plot_skymaps.html#gammapy.utils.pyfact.plot_skymaps">[docs]</a><span class="k">def</span> <span class="nf">plot_skymaps</span><span class="p">(</span><span class="n">event_map</span><span class="p">,</span> <span class="n">excess_map</span><span class="p">,</span> <span class="n">sign_map</span><span class="p">,</span> <span class="n">bg_map</span><span class="p">,</span> <span class="n">alpha_map</span><span class="p">,</span> <span class="n">titlestr</span><span class="p">,</span>
                 <span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">,</span> <span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">,</span> <span class="n">objcosdec</span><span class="p">,</span>
                 <span class="n">r_overs</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">skycenra</span><span class="p">,</span> <span class="n">skycendec</span><span class="p">,</span>
                 <span class="n">ring_bg_r_min</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ring_bg_r_max</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sign_hist_r_max</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Plot sky map function (using matplotlib only).</span>

<span class="sd">    TODO: document</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    TODO</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : `matplotlib.figure.Figure`</span>
<span class="sd">        Figure containing the plot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Circle</span>

    <span class="k">def</span> <span class="nf">set_title_and_axlabel</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;RA (deg)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Dec (deg)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;medium&#39;</span><span class="p">)</span>

    <span class="n">plt_r_ra</span> <span class="o">=</span> <span class="n">sky_ra_min</span> <span class="o">+</span> <span class="o">.</span><span class="mi">08</span> <span class="o">*</span> <span class="p">(</span><span class="n">sky_ra_max</span> <span class="o">-</span> <span class="n">sky_ra_min</span><span class="p">)</span> <span class="o">+</span> <span class="n">r_overs</span> <span class="o">/</span> <span class="n">objcosdec</span>
    <span class="n">plt_r_dec</span> <span class="o">=</span> <span class="n">sky_dec_min</span> <span class="o">+</span> <span class="o">.</span><span class="mi">08</span> <span class="o">*</span> <span class="p">(</span><span class="n">sky_dec_max</span> <span class="o">-</span> <span class="n">sky_dec_min</span><span class="p">)</span> <span class="o">+</span> <span class="n">r_overs</span> <span class="o">/</span> <span class="n">objcosdec</span>

    <span class="n">cir_overs</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">plt_r_ra</span><span class="p">,</span> <span class="n">plt_r_dec</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">r_overs</span> <span class="o">/</span> <span class="n">objcosdec</span><span class="p">,</span>
                       <span class="n">fill</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s">&#39;1.&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;1.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">6</span><span class="p">)</span>

    <span class="n">gauss_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=.</span><span class="mi">4</span><span class="p">,</span> <span class="n">left</span><span class="o">=.</span><span class="mo">07</span><span class="p">,</span> <span class="n">right</span><span class="o">=.</span><span class="mi">96</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=.</span><span class="mi">25</span><span class="p">,</span> <span class="n">top</span><span class="o">=.</span><span class="mi">93</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">231</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">event_map</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;Events&#39;</span><span class="p">)</span>
    <span class="n">set_title_and_axlabel</span><span class="p">(</span><span class="s">&#39;Events&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">cir_overs</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">232</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">excess_map</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;Excess events&#39;</span><span class="p">)</span>
    <span class="n">set_title_and_axlabel</span><span class="p">(</span><span class="n">titlestr</span> <span class="o">+</span> <span class="s">&#39; - Excess&#39;</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">233</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sign_map</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;Significance&#39;</span><span class="p">)</span>
    <span class="n">set_title_and_axlabel</span><span class="p">(</span><span class="n">titlestr</span> <span class="o">+</span> <span class="s">&#39;- Significance&#39;</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">234</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bg_map</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;Background events&#39;</span><span class="p">)</span>
    <span class="n">set_title_and_axlabel</span><span class="p">(</span><span class="n">titlestr</span> <span class="o">+</span> <span class="s">&#39; - Background&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ring_bg_r_min</span> <span class="ow">and</span> <span class="n">ring_bg_r_max</span><span class="p">:</span>
        <span class="n">plt_r_ra</span> <span class="o">=</span> <span class="n">sky_ra_min</span> <span class="o">+</span> <span class="o">.</span><span class="mo">03</span> <span class="o">*</span> <span class="p">(</span><span class="n">sky_ra_max</span> <span class="o">-</span> <span class="n">sky_ra_min</span><span class="p">)</span> <span class="o">+</span> <span class="n">ring_bg_r_max</span> <span class="o">/</span> <span class="n">objcosdec</span>
        <span class="n">plt_r_dec</span> <span class="o">=</span> <span class="n">sky_dec_min</span> <span class="o">+</span> <span class="o">.</span><span class="mo">03</span> <span class="o">*</span> <span class="p">(</span><span class="n">sky_dec_max</span> <span class="o">-</span> <span class="n">sky_dec_min</span><span class="p">)</span> <span class="o">+</span> <span class="n">ring_bg_r_max</span> <span class="o">/</span> <span class="n">objcosdec</span>

        <span class="c"># Plot ring background region as two circles</span>
        <span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">plt_r_ra</span><span class="p">,</span> <span class="n">plt_r_dec</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">ring_bg_r_max</span> <span class="o">/</span> <span class="n">objcosdec</span><span class="p">,</span>
                        <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s">&#39;1.&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;0.&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;solid&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
        <span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">plt_r_ra</span><span class="p">,</span> <span class="n">plt_r_dec</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">ring_bg_r_min</span> <span class="o">/</span> <span class="n">objcosdec</span><span class="p">,</span>
                        <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s">&#39;1.&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;0.&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">&#39;solid&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>

    <span class="n">circle</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="n">plt_r_ra</span><span class="p">,</span> <span class="n">plt_r_dec</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">r_overs</span> <span class="o">/</span> <span class="n">objcosdec</span><span class="p">,</span>
                    <span class="n">fill</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s">&#39;1.&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;1.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">235</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">alpha_map</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&#39;Alpha&#39;</span><span class="p">)</span>
    <span class="n">set_title_and_axlabel</span><span class="p">(</span><span class="n">titlestr</span> <span class="o">+</span> <span class="s">&#39; - Alpha&#39;</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">236</span><span class="p">)</span>
    <span class="n">sky_ex_reg_map</span> <span class="o">=</span> <span class="n">get_exclusion_region_map</span><span class="p">(</span><span class="n">event_map</span><span class="p">,</span> <span class="p">(</span><span class="n">sky_ra_min</span><span class="p">,</span> <span class="n">sky_ra_max</span><span class="p">),</span> <span class="p">(</span><span class="n">sky_dec_min</span><span class="p">,</span> <span class="n">sky_dec_max</span><span class="p">),</span>
                                                 <span class="p">[</span><span class="n">SkyCircle</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">skycenra</span><span class="p">,</span> <span class="n">skycendec</span><span class="p">),</span> <span class="n">sign_hist_r_max</span><span class="p">)])</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sign_map</span><span class="p">[</span><span class="n">sky_ex_reg_map</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">),</span>
                                <span class="n">histtype</span><span class="o">=</span><span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;SkyBlue&#39;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gauss_func</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Gauss ($\sigma=1.$, mean=0.)&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Significance R &lt; {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sign_hist_r_max</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">titlestr</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;medium&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">5.</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="s">&#39;small&#39;</span><span class="p">})</span>

</div>
<span class="k">def</span> <span class="nf">unique_base_file_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if a given file already exists. If yes, creates a new unique filename.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Base file name.</span>
<span class="sd">    extension : str/array, optional</span>
<span class="sd">        File extension(s).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Unique filename.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="k">def</span> <span class="nf">filename_exists</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">extension</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extension</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">):</span>
                        <span class="n">exists</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">extension</span><span class="p">):</span>
                    <span class="n">exists</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                        <span class="n">exists</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">exists</span>

    <span class="k">if</span> <span class="n">filename_exists</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;_%Y%m</span><span class="si">%d</span><span class="s">-%H%M%S&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename_exists</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">random</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">name</span>


<span class="k">def</span> <span class="nf">image_to_primaryhdu</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">rarange</span><span class="p">,</span> <span class="n">decrange</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="s">&#39;DUMMY&#39;</span><span class="p">,</span> <span class="n">object_</span><span class="o">=</span><span class="s">&#39;DUMMY&#39;</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s">&#39;DUMMY&#39;</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Converts a 2d numpy array into a FITS primary HDU (image).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    map : 2d array</span>
<span class="sd">        Skymap.</span>
<span class="sd">    rarange : array/tupel</span>
<span class="sd">        Tupel/Array with two entries giving the RA range of the map i.e. (ramin, ramax).</span>
<span class="sd">    decrange : array/tupel</span>
<span class="sd">        Tupel/Array with two entries giving the DEC range of the map i.e (decmin, decmax).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    hdu : astropy.io.fits.PrimaryHDU</span>
<span class="sd">      FITS primary HDU containing the skymap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">image_to_hdu</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">rarange</span><span class="p">,</span> <span class="n">decrange</span><span class="p">,</span> <span class="n">primary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="n">telescope</span><span class="p">,</span> <span class="n">object_</span><span class="o">=</span><span class="n">object_</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">image_to_hdu</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">rarange</span><span class="p">,</span> <span class="n">decrange</span><span class="p">,</span> <span class="n">primary</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">telescope</span><span class="o">=</span><span class="s">&#39;DUMMY&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="s">&#39;DUMMY&#39;</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="s">&#39;DUMMY&#39;</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Converts a 2d numpy array into a FITS primary HDU (image).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    map : 2d array</span>
<span class="sd">        Skymap.</span>
<span class="sd">    rarange : array/tupel</span>
<span class="sd">        Tupel/Array with two entries giving the RA range of the map i.e. (ramin, ramax).</span>
<span class="sd">    decrange : array/tupel</span>
<span class="sd">        Tupel/Array with two entries giving the DEC range of the map i.e (decmin, decmax).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    hdu : astropy.io.fits.PrimaryHDU</span>
<span class="sd">        FITS primary HDU containing the skymap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">decnbins</span><span class="p">,</span> <span class="n">ranbins</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">decstep</span> <span class="o">=</span> <span class="p">(</span><span class="n">decrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">decrange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">decnbins</span><span class="p">)</span>
    <span class="n">rastep</span> <span class="o">=</span> <span class="p">(</span><span class="n">rarange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rarange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ranbins</span><span class="p">)</span>

    <span class="n">hdu</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">primary</span><span class="p">:</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>

    <span class="c"># Image definition</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;RA---CAR&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CTYPE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;DEC--CAR&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CUNIT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;deg&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CUNIT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;deg&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rarange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c"># Must be zero for the lines to be rectilinear according to Calabretta (2002)</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">decrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">decstep</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span>  <span class="c"># Pixel outside of the image at DEC = 0.</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rastep</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decstep</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;RADESYS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;FK5&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;BUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;count&#39;</span>

    <span class="c"># Extra data</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;TELESCOP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">telescope</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;OBJECT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">object</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;AUTHOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">author</span>

    <span class="k">return</span> <span class="n">hdu</span>


<span class="k">def</span> <span class="nf">create_spectrum</span><span class="p">(</span><span class="n">input_file_names</span><span class="p">,</span>
                    <span class="n">analysis_position</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">analysis_radius</span><span class="o">=.</span><span class="mi">125</span><span class="p">,</span>
                    <span class="n">match_rmf</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">datadir</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">write_output_files</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">do_graphical_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">loglevel</span><span class="o">=</span><span class="s">&#39;INFO&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates spectra from VHE event lists in FITS format.</span>

<span class="sd">    TODO: describe</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    TODO</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TODO</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Loop over the file list, calculate quantities, &amp; fill histograms</span>

    <span class="c"># Exclusion radius [this should be generalized in future versions]</span>
    <span class="n">rexdeg</span> <span class="o">=</span> <span class="o">.</span><span class="mi">3</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;pfspec is currently using a single exclusion region for background extraction set on the analysis position (r = {0})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rexdeg</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;This should be improved in future versions (tm).&#39;</span><span class="p">)</span>

    <span class="c"># Intialize some variables</span>
    <span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span><span class="p">,</span> <span class="n">pntra</span><span class="p">,</span> <span class="n">pntdec</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">analysis_position</span><span class="p">:</span>
        <span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">analysis_position</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Analysis position: RA {0}, Dec {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;No analysis position given =&gt; will use object position from first file&#39;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Analysis radius: {0} deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">analysis_radius</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">write_output_files</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;The output files can be found in {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>

    <span class="n">theta2_hist_max</span><span class="p">,</span> <span class="n">theta2_hist_nbins</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">,</span> <span class="mi">50</span>
    <span class="n">theta2_on_hist</span><span class="p">,</span> <span class="n">theta2_off_hist</span><span class="p">,</span> <span class="n">theta2_offcor_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">theta2_hist_nbins</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">theta2_hist_nbins</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">theta2_hist_nbins</span><span class="p">)</span>
    <span class="n">non</span><span class="p">,</span> <span class="n">noff</span><span class="p">,</span> <span class="n">noffcor</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
    <span class="n">sky_ex_reg</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">firstloop</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">spec_nbins</span><span class="p">,</span> <span class="n">spec_emin</span><span class="p">,</span> <span class="n">spec_emax</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span>
    <span class="n">telescope</span><span class="p">,</span> <span class="n">instrument</span> <span class="o">=</span> <span class="s">&#39;DUMMY&#39;</span><span class="p">,</span> <span class="s">&#39;DUMMY&#39;</span>

    <span class="n">arf_m</span><span class="p">,</span> <span class="n">arf_m_erange</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">match_rmf</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Matching total PHA binning to RMF file: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match_rmf</span><span class="p">))</span>
        <span class="n">edisp</span> <span class="o">=</span> <span class="n">EnergyDispersion</span><span class="p">(</span><span class="n">match_rmf</span><span class="p">)</span>
        <span class="n">ebounds</span> <span class="o">=</span> <span class="n">edisp</span><span class="o">.</span><span class="n">energy_bounds</span><span class="p">(</span><span class="s">&#39;reco&#39;</span><span class="p">)</span>
        <span class="n">erange</span> <span class="o">=</span> <span class="n">edisp</span><span class="o">.</span><span class="n">energy_bounds</span><span class="p">(</span><span class="s">&#39;true&#39;</span><span class="p">)</span>
        <span class="n">spec_nbins</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ebounds</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">spec_emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ebounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">spec_emax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ebounds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">arf_m_erange</span> <span class="o">=</span> <span class="n">erange</span>

        <span class="n">edisp_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">match_rmf</span><span class="p">,</span> <span class="n">extnr</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;INSTRUME&#39;</span> <span class="ow">in</span> <span class="n">edisp_header</span><span class="p">:</span>
            <span class="n">instrument</span> <span class="o">=</span> <span class="n">edisp_header</span><span class="p">[</span><span class="s">&#39;INSTRUME&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;TELESCOP&#39;</span> <span class="ow">in</span> <span class="n">edisp_header</span><span class="p">:</span>
            <span class="n">telescope</span> <span class="o">=</span> <span class="n">edisp_header</span><span class="p">[</span><span class="s">&#39;TELESCOP&#39;</span><span class="p">]</span>

    <span class="n">spec_on_hist</span><span class="p">,</span> <span class="n">spec_off_hist</span><span class="p">,</span> <span class="n">spec_off_cor_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spec_nbins</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spec_nbins</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spec_nbins</span><span class="p">)</span>
    <span class="n">spec_hist_ebounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">spec_emin</span><span class="p">,</span> <span class="n">spec_emax</span><span class="p">,</span> <span class="n">spec_nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">dstart</span><span class="p">,</span> <span class="n">dstop</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="n">exposure</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c"># [s]</span>

    <span class="c"># Read in input file, can be individual fits or bankfile</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Opening input file(s) ..&#39;</span><span class="p">)</span>

    <span class="c"># This list will hold the individual file names as strings</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Check if we are dealing with a single file or a bankfile</span>
    <span class="c"># and create/read in the file list accordingly</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_file_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_file_names</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Reading files from batchfile {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_file_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">input_file_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;S&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">file_list</span><span class="p">])</span>

    <span class="c"># Sanity checks on input file(s)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;No entries in bankfile&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Bankfile must have three columns (data/arf/rmf)&#39;</span><span class="p">)</span>

    <span class="c"># Shortcuts for commonly used functions</span>
    <span class="n">cci_f</span><span class="p">,</span> <span class="n">cci_a</span> <span class="o">=</span> <span class="n">circle_circle_intersection_float</span><span class="p">,</span> <span class="n">circle_circle_intersection_array</span>

    <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="n">dataf</span><span class="p">,</span> <span class="n">arf</span><span class="p">,</span> <span class="n">rmf</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datadir</span> <span class="o">+</span> <span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">datadir</span> <span class="o">+</span> <span class="n">files</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;==== Processing file {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataf</span><span class="p">))</span>

        <span class="c"># Open fits file</span>
        <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dataf</span><span class="p">)</span>

        <span class="c"># Print file info</span>
        <span class="c"># hdulist.info()</span>

        <span class="c"># Access header of second extension</span>
        <span class="n">ex1hdr</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

        <span class="c"># Print header of the first extension as ascardlist</span>
        <span class="c"># print ex1hdr.ascardlist()</span>

        <span class="c"># Access data of first extension</span>
        <span class="n">tbdata</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c"># assuming the first extension is a table</span>

        <span class="c"># Print table columns</span>
        <span class="c"># hdulist[1].columns.info()</span>

        <span class="c">#---------------------------------------------------------------------------</span>
        <span class="c"># Calculate some useful quantities and add them to the table</span>

        <span class="k">if</span> <span class="n">firstloop</span><span class="p">:</span>
            <span class="c"># If skymap center is not set, set it to the target position of the first run</span>
            <span class="k">if</span> <span class="n">objra</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">objdec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span> <span class="o">=</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;RA_OBJ&#39;</span><span class="p">],</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;DEC_OBJ&#39;</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Analysis position from header: RA {0}, Dec {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span><span class="p">))</span>

        <span class="n">pntra</span><span class="p">,</span> <span class="n">pntdec</span> <span class="o">=</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;RA_PNT&#39;</span><span class="p">],</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;DEC_PNT&#39;</span><span class="p">]</span>
        <span class="n">obj_cam_dist</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span><span class="p">)</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">pntra</span><span class="p">,</span> <span class="n">pntdec</span><span class="p">))</span>

        <span class="c"># If no exclusion regions are given, use the object position from the first run</span>
        <span class="k">if</span> <span class="n">sky_ex_reg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sky_ex_reg</span> <span class="o">=</span> <span class="p">[</span><span class="n">SkyCircle</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span><span class="p">),</span> <span class="n">rexdeg</span><span class="p">)]</span>

        <span class="n">exposure_run</span> <span class="o">=</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;LIVETIME&#39;</span><span class="p">]</span>
        <span class="n">exposure</span> <span class="o">+=</span> <span class="n">exposure_run</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Start date/time : {0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;DATE_OBS&#39;</span><span class="p">],</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;TIME_OBS&#39;</span><span class="p">]))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Stop date/time  : {0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;DATE_END&#39;</span><span class="p">],</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;TIME_END&#39;</span><span class="p">]))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Exposure        : {0:.2f} [s]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exposure_run</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Pointing pos.   : RA {0:.4f} [deg], Dec {1:.4f} [deg]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pntra</span><span class="p">,</span> <span class="n">pntdec</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Obj. cam. dist. : {0:.4f} [deg]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj_cam_dist</span><span class="p">))</span>

        <span class="n">run_dstart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;DATE_OBS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;TIME_OBS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))])</span>
        <span class="n">run_dstop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;DATE_END&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ex1hdr</span><span class="p">[</span><span class="s">&#39;TIME_END&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))])</span>
        <span class="k">if</span> <span class="n">firstloop</span><span class="p">:</span>
            <span class="n">dstart</span> <span class="o">=</span> <span class="n">run_dstart</span>
        <span class="n">dstop</span> <span class="o">=</span> <span class="n">run_dstop</span>

        <span class="c"># Distance from the camera (FOV) center</span>
        <span class="n">camdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DETX    &#39;</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DETY    &#39;</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>

        <span class="c"># Distance from analysis position</span>
        <span class="n">thetadist</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">objra</span><span class="p">,</span> <span class="n">objdec</span><span class="p">)</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;RA      &#39;</span><span class="p">),</span> <span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;DEC    &#39;</span><span class="p">)))</span>

        <span class="c"># # cos(DEC)</span>
        <span class="c"># cosdec = np.cos(tbdata.field(&#39;DEC     &#39;) * np.pi / 180.)</span>
        <span class="c"># cosdec_col = fits.Column(name=&#39;XCOSDEC&#39;, format=&#39;1E&#39;, array=cosdec)</span>

        <span class="c"># Add new columns to the table</span>
        <span class="n">coldefs_new</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">(</span>
            <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;XCAMDIST&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;1E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">camdist</span><span class="p">),</span>
             <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;XTHETA&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;1E&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">thetadist</span><span class="p">)</span>
             <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">newtable</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">+</span> <span class="n">coldefs_new</span><span class="p">)</span>

        <span class="c"># Print new table columns</span>
        <span class="c"># newtable.columns.info()</span>

        <span class="n">mgit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbdata</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Note: according to the eventlist format document v1.0.0 Section 10</span>
            <span class="c"># &quot;The times are expressed in the same units as in the EVENTS</span>
            <span class="c"># table (seconds since mission start in terresterial time).&quot;</span>
            <span class="k">for</span> <span class="n">gti</span> <span class="ow">in</span> <span class="n">hdulist</span><span class="p">[</span><span class="s">&#39;GTI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="p">:</span>
                <span class="n">mgit</span> <span class="o">*=</span> <span class="p">(</span><span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;TIME&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">gti</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">tbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;TIME&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">gti</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;File does not contain a GTI extension&#39;</span><span class="p">)</span>

        <span class="c"># New table data</span>
        <span class="n">tbdata</span> <span class="o">=</span> <span class="n">newtable</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mgit</span><span class="p">]</span>

        <span class="c">#---------------------------------------------------------------------------</span>
        <span class="c"># Select signal and background events</span>

        <span class="n">photbdata</span> <span class="o">=</span> <span class="n">tbdata</span>

        <span class="n">on_run</span> <span class="o">=</span> <span class="n">photbdata</span><span class="p">[</span><span class="n">photbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XTHETA&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">analysis_radius</span><span class="p">]</span>
        <span class="n">off_run</span> <span class="o">=</span> <span class="n">photbdata</span><span class="p">[((</span><span class="n">photbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XCAMDIST&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">obj_cam_dist</span> <span class="o">+</span> <span class="n">analysis_radius</span><span class="p">)</span>
                             <span class="o">*</span> <span class="p">(</span><span class="n">photbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XCAMDIST&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">obj_cam_dist</span> <span class="o">-</span> <span class="n">analysis_radius</span><span class="p">)</span>
                             <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">photbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XTHETA&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rexdeg</span><span class="p">))]</span>

        <span class="n">spec_on_run_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">on_run</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;ENERGY&#39;</span><span class="p">)),</span> <span class="n">bins</span><span class="o">=</span><span class="n">spec_nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">spec_emin</span><span class="p">,</span> <span class="n">spec_emax</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spec_on_hist</span> <span class="o">+=</span> <span class="n">spec_on_run_hist</span>

        <span class="n">non_run</span><span class="p">,</span> <span class="n">noff_run</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">on_run</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">off_run</span><span class="p">)</span>

        <span class="n">alpha_run</span> <span class="o">=</span> <span class="n">analysis_radius</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">/</span> <span class="p">((</span><span class="n">obj_cam_dist</span> <span class="o">+</span> <span class="n">analysis_radius</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span>
                                           <span class="o">-</span> <span class="p">(</span><span class="n">obj_cam_dist</span> <span class="o">-</span> <span class="n">analysis_radius</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span>
                                           <span class="o">-</span> <span class="n">cci_f</span><span class="p">(</span><span class="n">obj_cam_dist</span> <span class="o">+</span> <span class="n">analysis_radius</span><span class="p">,</span> <span class="n">rexdeg</span><span class="p">,</span> <span class="n">obj_cam_dist</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                                           <span class="o">+</span> <span class="n">cci_f</span><span class="p">(</span><span class="n">obj_cam_dist</span> <span class="o">-</span> <span class="n">analysis_radius</span><span class="p">,</span> <span class="n">rexdeg</span><span class="p">,</span> <span class="n">obj_cam_dist</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="n">spec_off_run_hist</span><span class="p">,</span> <span class="n">ebins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">off_run</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;ENERGY&#39;</span><span class="p">)),</span> <span class="n">bins</span><span class="o">=</span><span class="n">spec_nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">spec_emin</span><span class="p">,</span> <span class="n">spec_emax</span><span class="p">))</span>
        <span class="n">spec_off_hist</span> <span class="o">+=</span> <span class="n">spec_off_run_hist</span>
        <span class="n">spec_off_cor_hist</span> <span class="o">+=</span> <span class="n">spec_off_run_hist</span> <span class="o">*</span> <span class="n">alpha_run</span>

        <span class="c"># DEBUG plot</span>
        <span class="c"># plt.plot(ebins[:-1], spec_on_hist, label=&#39;ON&#39;)</span>
        <span class="c"># plt.plot(ebins[:-1], spec_off_cor_hist, label=&#39;OFF cor.&#39;)</span>
        <span class="c"># plt.legend()</span>
        <span class="c"># plt.show()</span>

        <span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="n">non</span><span class="p">,</span> <span class="n">noff</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="s">&#39;N_ON = {0}, N_OFF = {1}, ALPHA = {2:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">non</span><span class="p">,</span> <span class="n">noff</span><span class="p">,</span> <span class="n">alpha</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="s">&#39;EXCESS = {0:.2f}, SIGN = {1:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">non</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">noff</span><span class="p">,</span> <span class="n">significance_on_off</span><span class="p">(</span><span class="n">non</span><span class="p">,</span> <span class="n">noff</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)))</span>

        <span class="n">non</span> <span class="o">+=</span> <span class="n">non_run</span>
        <span class="n">noff</span> <span class="o">+=</span> <span class="n">noff_run</span>
        <span class="n">noffcor</span> <span class="o">+=</span> <span class="n">alpha_run</span> <span class="o">*</span> <span class="n">noff_run</span>

        <span class="n">print_stats</span><span class="p">(</span><span class="n">non_run</span><span class="p">,</span> <span class="n">noff_run</span><span class="p">,</span> <span class="n">alpha_run</span><span class="p">,</span> <span class="s">&#39;RUN &#39;</span><span class="p">)</span>
        <span class="n">print_stats</span><span class="p">(</span><span class="n">non</span><span class="p">,</span> <span class="n">noff</span><span class="p">,</span> <span class="n">noffcor</span> <span class="o">/</span> <span class="n">noff</span><span class="p">,</span> <span class="s">&#39;TOTAL &#39;</span><span class="p">)</span>

        <span class="n">theta2_on_hist</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">photbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XTHETA&#39;</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">theta2_hist_nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">theta2_hist_max</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">theta2_off_run_hist</span><span class="p">,</span> <span class="n">theta2_off_run_hist_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">((</span><span class="n">photbdata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">photbdata</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XTHETA&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rexdeg</span><span class="p">)]</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;XCAMDIST&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">obj_cam_dist</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">theta2_hist_nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">theta2_hist_max</span><span class="p">))</span>

        <span class="n">theta2_off_hist</span> <span class="o">+=</span> <span class="n">theta2_off_run_hist</span>

        <span class="n">h_edges_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">theta2_off_run_hist_edges</span><span class="p">)</span>

        <span class="n">a_tmp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">cci_a</span><span class="p">(</span><span class="n">obj_cam_dist</span> <span class="o">+</span> <span class="n">h_edges_r</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">theta2_hist_nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rexdeg</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">theta2_hist_nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">obj_cam_dist</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="o">-</span> <span class="n">cci_a</span><span class="p">(</span><span class="n">obj_cam_dist</span> <span class="o">-</span> <span class="n">h_edges_r</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">theta2_hist_nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rexdeg</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">theta2_hist_nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">obj_cam_dist</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="p">)</span>

        <span class="n">theta2_off_hist_alpha</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">theta2_off_run_hist_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">theta2_off_run_hist_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">obj_cam_dist</span> <span class="o">*</span> <span class="p">(</span><span class="n">h_edges_r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">h_edges_r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
               <span class="o">-</span> <span class="p">(</span><span class="n">a_tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">a_tmp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
               <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">theta2_offcor_hist</span> <span class="o">+=</span> <span class="n">theta2_off_run_hist</span> <span class="o">*</span> <span class="n">theta2_off_hist_alpha</span>

        <span class="c"># Read run ARF file</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Reading ARF from : {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arf</span><span class="p">))</span>
        <span class="n">arf_obj</span> <span class="o">=</span> <span class="n">EffectiveAreaTable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">arf</span><span class="p">)</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="n">arf_obj</span><span class="o">.</span><span class="n">effective_area</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ea_erange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">arf_obj</span><span class="o">.</span><span class="n">energy_lo</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">arf_obj</span><span class="o">.</span><span class="n">energy_hi</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">arf_obj</span>

        <span class="c"># If average ARF is not matched to RMF use first ARF as template</span>
        <span class="k">if</span> <span class="n">firstloop</span> <span class="ow">and</span> <span class="n">arf_m_erange</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">arf_m_erange</span> <span class="o">=</span> <span class="n">ea_erange</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ea_erange</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">arf_m_erange</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">ea_erange</span> <span class="o">-</span> <span class="n">arf_m_erange</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1E-5</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Average ARF - ARF binning does not match RMF for file: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arf</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Average ARF - Resampling ARF to match RMF EBOUNDS binning&#39;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">UnivariateSpline</span>
            <span class="n">ea_spl</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ea_erange</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ea_erange</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ea</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ea</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">ea_spl</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">arf_m_erange</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">arf_m_erange</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">firstloop</span><span class="p">:</span>
            <span class="n">arf_m</span> <span class="o">=</span> <span class="n">ea</span> <span class="o">*</span> <span class="n">exposure_run</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arf_m</span> <span class="o">+=</span> <span class="n">ea</span> <span class="o">*</span> <span class="n">exposure_run</span>

        <span class="c"># # DEBUG plot</span>
        <span class="c"># plt.errorbar(spec_hist_ebounds[:-1], dat, yerr=dat_err)</span>
        <span class="c"># plt.title(dataf)</span>
        <span class="c"># plt.show()</span>

        <span class="c"># Write run wise data to PHA</span>
        <span class="k">if</span> <span class="n">write_output_files</span><span class="p">:</span>

            <span class="c"># Create base file name for run wise output files</span>
            <span class="n">run_out_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dataf</span><span class="p">[:</span><span class="n">dataf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.fits&#39;</span><span class="p">)])</span>

            <span class="c"># Open run RMF file</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Reading RMF from : {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rmf</span><span class="p">))</span>
            <span class="n">edisp</span> <span class="o">=</span> <span class="n">EnergyDispersion</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">rmf</span><span class="p">)</span>
            <span class="n">ebounds</span> <span class="o">=</span> <span class="n">edisp</span><span class="o">.</span><span class="n">energy_bounds</span><span class="p">(</span><span class="s">&#39;reco&#39;</span><span class="p">)</span>

            <span class="c"># Bin data to match EBOUNDS from RMF</span>
            <span class="n">spec_on_run_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">on_run</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;ENERGY&#39;</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">ebounds</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">spec_off_run_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">off_run</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s">&#39;ENERGY&#39;</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">ebounds</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c"># Prepare excess data</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">spec_on_run_hist</span> <span class="o">-</span> <span class="n">alpha_run</span> <span class="o">*</span> <span class="n">spec_off_run_hist</span>  <span class="c"># ON - alpha x OFF = Excess</span>
            <span class="n">dat_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">spec_on_run_hist</span> <span class="o">+</span> <span class="n">spec_off_run_hist</span> <span class="o">*</span> <span class="n">alpha_run</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">spec_on_run_hist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">spec_off_run_hist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c"># Set quality flags</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span>

            <span class="c"># Signal PHA</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">np_to_pha</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">chan</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="n">spec_on_run_hist</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="n">quality</span><span class="p">,</span>
                            <span class="n">exposure</span><span class="o">=</span><span class="n">exposure_run</span><span class="p">,</span> <span class="n">obj_ra</span><span class="o">=</span><span class="n">objra</span><span class="p">,</span> <span class="n">obj_dec</span><span class="o">=</span><span class="n">objdec</span><span class="p">,</span>
                            <span class="n">dstart</span><span class="o">=</span><span class="n">run_dstart</span><span class="p">,</span> <span class="n">dstop</span><span class="o">=</span><span class="n">run_dstop</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="s">&#39;pfspec&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                            <span class="n">telescope</span><span class="o">=</span><span class="n">telescope</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;ANCRFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">arf</span><span class="p">),</span> <span class="s">&#39;Ancillary response file (ARF)&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;RESPFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rmf</span><span class="p">),</span> <span class="s">&#39;Redistribution matrix file (RMF)&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;BACKFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_out_basename</span> <span class="o">+</span> <span class="s">&#39;_bg.pha.fits&#39;</span><span class="p">,</span> <span class="s">&#39;Bkgr FITS file&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;BACKSCAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_run</span><span class="p">,</span> <span class="s">&#39;Background scale factor&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;HDUCLAS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;TOTAL&#39;</span><span class="p">,</span> <span class="s">&#39;Extension contains source + bkgd&#39;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">run_out_basename</span> <span class="o">+</span> <span class="s">&#39;_signal.pha.fits&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Writing signal PHA file to {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="c"># Background PHA</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">np_to_pha</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">chan</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="n">spec_off_run_hist</span><span class="p">,</span>
                            <span class="n">exposure</span><span class="o">=</span><span class="n">exposure_run</span><span class="p">,</span> <span class="n">obj_ra</span><span class="o">=</span><span class="n">objra</span><span class="p">,</span> <span class="n">obj_dec</span><span class="o">=</span><span class="n">objdec</span><span class="p">,</span>
                            <span class="n">dstart</span><span class="o">=</span><span class="n">run_dstart</span><span class="p">,</span> <span class="n">dstop</span><span class="o">=</span><span class="n">run_dstop</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="s">&#39;pfspec&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                            <span class="n">telescope</span><span class="o">=</span><span class="n">telescope</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;ANCRFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">arf</span><span class="p">),</span> <span class="s">&#39;Ancillary response file (ARF)&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;RESPFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rmf</span><span class="p">),</span> <span class="s">&#39;Redistribution matrix file (RMF)&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;HDUCLAS2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;TOTAL&#39;</span><span class="p">,</span> <span class="s">&#39;Extension contains source + bkgd&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Writing background PHA file to {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_out_basename</span> <span class="o">+</span> <span class="s">&#39;_bg.pha.fits&#39;</span><span class="p">))</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">run_out_basename</span> <span class="o">+</span> <span class="s">&#39;_bg.pha.fits&#39;</span><span class="p">)</span>

            <span class="c"># Excess PHA</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">np_to_pha</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">chan</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">stat_err</span><span class="o">=</span><span class="n">dat_err</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="n">exposure_run</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="n">quality</span><span class="p">,</span>
                            <span class="n">obj_ra</span><span class="o">=</span><span class="n">objra</span><span class="p">,</span> <span class="n">obj_dec</span><span class="o">=</span><span class="n">objdec</span><span class="p">,</span>
                            <span class="n">dstart</span><span class="o">=</span><span class="n">run_dstart</span><span class="p">,</span> <span class="n">dstop</span><span class="o">=</span><span class="n">run_dstop</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="s">&#39;pfspec&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                            <span class="n">telescope</span><span class="o">=</span><span class="n">telescope</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;ANCRFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">arf</span><span class="p">),</span> <span class="s">&#39;Ancillary response file (ARF)&#39;</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;RESPFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rmf</span><span class="p">),</span> <span class="s">&#39;Redistribution matrix file (RMF)&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;RUN Writing excess PHA file to {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_out_basename</span> <span class="o">+</span> <span class="s">&#39;_excess.pha.fits&#39;</span><span class="p">))</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">run_out_basename</span> <span class="o">+</span> <span class="s">&#39;_excess.pha.fits&#39;</span><span class="p">)</span>

        <span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">firstloop</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Write results to file</span>

    <span class="n">arf_m</span> <span class="o">/=</span> <span class="n">exposure</span>

    <span class="k">if</span> <span class="n">write_output_files</span><span class="p">:</span>
        <span class="c"># Prepare data</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">spec_on_hist</span> <span class="o">-</span> <span class="n">spec_off_cor_hist</span>  <span class="c"># ON - alpha x OFF = Excess</span>
        <span class="n">dat_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">spec_on_hist</span> <span class="o">+</span> <span class="n">spec_off_hist</span> <span class="o">*</span> <span class="p">(</span><span class="n">spec_off_cor_hist</span> <span class="o">/</span> <span class="n">spec_off_hist</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="n">quality</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">spec_on_hist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">spec_off_hist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c"># Set quality flags</span>
        <span class="n">chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span>

        <span class="c"># # DEBUG plot</span>
        <span class="c"># plt.errorbar(spec_hist_ebounds[:-1], dat, yerr=dat_err)</span>
        <span class="c"># plt.title(&#39;Total&#39;)</span>
        <span class="c"># plt.show()</span>

        <span class="c"># Data to PHA</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">np_to_pha</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">chan</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">stat_err</span><span class="o">=</span><span class="n">dat_err</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="n">exposure</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="n">quality</span><span class="p">,</span>
                        <span class="n">obj_ra</span><span class="o">=</span><span class="n">objra</span><span class="p">,</span> <span class="n">obj_dec</span><span class="o">=</span><span class="n">objdec</span><span class="p">,</span>
                        <span class="n">dstart</span><span class="o">=</span><span class="n">dstart</span><span class="p">,</span> <span class="n">dstop</span><span class="o">=</span><span class="n">dstop</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="s">&#39;pfspec&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                        <span class="n">telescope</span><span class="o">=</span><span class="n">telescope</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>
        <span class="c"># Write PHA to file</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;ANCRFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="s">&#39;average.arf.fits&#39;</span><span class="p">),</span> <span class="s">&#39;Ancillary response file (ARF)&#39;</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s">&#39;average.pha.fits&#39;</span><span class="p">)</span>

        <span class="c"># Write ARF</span>
        <span class="n">energy_lo</span> <span class="o">=</span> <span class="n">arf_m_erange</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">energy_hi</span> <span class="o">=</span> <span class="n">arf_m_erange</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">arf_obj</span> <span class="o">=</span> <span class="n">EffectiveAreaTable</span><span class="p">(</span><span class="n">energy_lo</span><span class="p">,</span> <span class="n">energy_hi</span><span class="p">,</span> <span class="n">arf_m</span><span class="p">)</span>
        <span class="n">hdu_list</span> <span class="o">=</span> <span class="n">arf_obj</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="s">&#39;pyfact&#39;</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="n">telescope</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>
        <span class="n">hdu_list</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s">&#39;average.arf.fits&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">arf_obj</span>
    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Plot results</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="n">has_matplotlib</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">has_matplotlib</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">has_matplotlib</span> <span class="ow">and</span> <span class="n">do_graphical_output</span><span class="p">:</span>

        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Plotting results (matplotlib v{0})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">set_title_and_axlabel</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;RA (deg)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Dec (deg)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;medium&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">theta2_hist_max</span><span class="p">,</span> <span class="n">theta2_hist_nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">theta2_on_hist</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="p">(</span><span class="n">theta2_hist_max</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span>  <span class="n">theta2_hist_nbins</span><span class="p">)),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">theta2_on_hist</span><span class="p">),</span>
                     <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">r&#39;N$_{ON}$&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">theta2_offcor_hist</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="p">(</span><span class="n">theta2_hist_max</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span>  <span class="n">theta2_hist_nbins</span><span class="p">)),</span>
                     <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">theta2_off_hist</span><span class="p">)</span> <span class="o">*</span> <span class="n">theta2_offcor_hist</span> <span class="o">/</span> <span class="n">theta2_off_hist</span><span class="p">,</span>
                     <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">r&#39;N$_{OFF} \times \alpha$&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">analysis_radius</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">r&#39;$\theta^2$ cut&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">r&#39;$\theta^2$ (deg$^2$)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">r&#39;N&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">ecen</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec_hist_ebounds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">spec_hist_ebounds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">ecen</span><span class="p">,</span> <span class="n">spec_on_hist</span><span class="p">,</span>
                     <span class="n">xerr</span><span class="o">=</span><span class="p">(</span><span class="n">spec_hist_ebounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spec_hist_ebounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                     <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">spec_on_hist</span><span class="p">),</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;ON&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">ecen</span><span class="p">,</span> <span class="n">spec_off_cor_hist</span><span class="p">,</span>
                     <span class="n">xerr</span><span class="o">=</span><span class="p">(</span><span class="n">spec_hist_ebounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spec_hist_ebounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                     <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">spec_off_hist</span><span class="p">)</span> <span class="o">*</span> <span class="n">spec_off_cor_hist</span> <span class="o">/</span> <span class="n">spec_off_hist</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;OFF cor.&#39;</span><span class="p">)</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">spec_on_hist</span> <span class="o">-</span> <span class="n">spec_off_cor_hist</span>
        <span class="n">dat_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">spec_on_hist</span> <span class="o">+</span> <span class="n">spec_off_hist</span> <span class="o">*</span> <span class="p">(</span><span class="n">spec_off_cor_hist</span> <span class="o">/</span> <span class="n">spec_off_hist</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">ecen</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">dat_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;ON - OFF cor.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">r&#39;log(E/1 TeV)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">r&#39;N&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<div class="viewcode-block" id="root_axis_to_array"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.root_axis_to_array.html#gammapy.utils.pyfact.root_axis_to_array">[docs]</a><span class="k">def</span> <span class="nf">root_axis_to_array</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">GetNbins</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">GetNbins</span><span class="p">()):</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">GetBinLowEdge</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">GetBinUpEdge</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">GetNbins</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">a</span>

</div>
<div class="viewcode-block" id="root_1dhist_to_array"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.root_1dhist_to_array.html#gammapy.utils.pyfact.root_1dhist_to_array">[docs]</a><span class="k">def</span> <span class="nf">root_1dhist_to_array</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">GetNbins</span><span class="p">()</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span><span class="p">):</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">GetBinError</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="root_2dhist_to_array"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.root_2dhist_to_array.html#gammapy.utils.pyfact.root_2dhist_to_array">[docs]</a><span class="k">def</span> <span class="nf">root_2dhist_to_array</span><span class="p">(</span><span class="n">hist2d</span><span class="p">):</span>
    <span class="n">nbinsx</span> <span class="o">=</span> <span class="n">hist2d</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">GetNbins</span><span class="p">()</span>
    <span class="n">nbinsy</span> <span class="o">=</span> <span class="n">hist2d</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">.</span><span class="n">GetNbins</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nbinsx</span><span class="p">,</span> <span class="n">nbinsy</span><span class="p">])</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nbinsx</span><span class="p">,</span> <span class="n">nbinsy</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbinsx</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbinsy</span><span class="p">):</span>
            <span class="n">a</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist2d</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">e</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist2d</span><span class="o">.</span><span class="n">GetBinError</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="root_th1_to_fitstable"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.root_th1_to_fitstable.html#gammapy.utils.pyfact.root_th1_to_fitstable">[docs]</a><span class="k">def</span> <span class="nf">root_th1_to_fitstable</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">xunit</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">yunit</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="n">d</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">root_1dhist_to_array</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">root_axis_to_array</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">())</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span>
        <span class="p">[</span><span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;BIN_LO&#39;</span><span class="p">,</span>
                       <span class="n">format</span><span class="o">=</span><span class="s">&#39;1E&#39;</span><span class="p">,</span>
                       <span class="n">array</span><span class="o">=</span><span class="n">ax</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">unit</span><span class="o">=</span><span class="n">xunit</span><span class="p">),</span>
         <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;BIN_HI&#39;</span><span class="p">,</span>
                       <span class="n">format</span><span class="o">=</span><span class="s">&#39;1E&#39;</span><span class="p">,</span>
                       <span class="n">array</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                       <span class="n">unit</span><span class="o">=</span><span class="n">xunit</span><span class="p">),</span>
         <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;VAL&#39;</span><span class="p">,</span>
                       <span class="n">format</span><span class="o">=</span><span class="s">&#39;1E&#39;</span><span class="p">,</span>
                       <span class="n">array</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>
                       <span class="n">unit</span><span class="o">=</span><span class="n">yunit</span><span class="p">),</span>
         <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;ERR&#39;</span><span class="p">,</span>
                       <span class="n">format</span><span class="o">=</span><span class="s">&#39;1E&#39;</span><span class="p">,</span>
                       <span class="n">array</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                       <span class="n">unit</span><span class="o">=</span><span class="n">yunit</span><span class="p">)</span>
         <span class="p">]</span>
        <span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;ROOTTI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">GetTitle</span><span class="p">(),</span> <span class="s">&#39;ROOT hist. title&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;ROOTXTI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">GetTitle</span><span class="p">(),</span> <span class="s">&#39;ROOT X-axis title&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;ROOTYTI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">.</span><span class="n">GetTitle</span><span class="p">(),</span> <span class="s">&#39;ROOT Y-axis title&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;ROOTUN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&#39;ROOT n underflow&#39;</span>
    <span class="n">header</span><span class="p">[</span><span class="s">&#39;ROOTOV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">GetNbins</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&#39;ROOT n overflow&#39;</span>
    <span class="k">return</span> <span class="n">hdu</span>

</div>
<div class="viewcode-block" id="plot_th1"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.plot_th1.html#gammapy.utils.pyfact.plot_th1">[docs]</a><span class="k">def</span> <span class="nf">plot_th1</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="n">d</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">root_1dhist_to_array</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">root_axis_to_array</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">logy</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">((</span><span class="n">ax</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">ax</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">GetTitle</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">.</span><span class="n">GetTitle</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">GetTitle</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="s">&#39;small&#39;</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
        <span class="n">tick</span><span class="o">.</span><span class="n">label1</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
        <span class="n">tick</span><span class="o">.</span><span class="n">label1</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">return</span>

</div>
<div class="viewcode-block" id="fit_th1"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.fit_th1.html#gammapy.utils.pyfact.fit_th1">[docs]</a><span class="k">def</span> <span class="nf">fit_th1</span><span class="p">(</span><span class="n">fitter</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">errscale</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">xaxlog</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span> <span class="o">=</span> <span class="n">root_1dhist_to_array</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">errscale</span><span class="p">:</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="n">errscale</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">root_axis_to_array</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">())</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">ax</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xaxlog</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">range_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">range_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">range_</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="n">yerr</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
    <span class="n">fitter</span><span class="o">.</span><span class="n">fit_data</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">fitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="cta_irf_root_to_fits"><a class="viewcode-back" href="../../../api/gammapy.utils.pyfact.cta_irf_root_to_fits.html#gammapy.utils.pyfact.cta_irf_root_to_fits">[docs]</a><span class="k">def</span> <span class="nf">cta_irf_root_to_fits</span><span class="p">(</span><span class="n">irf_root_file_name</span><span class="p">,</span> <span class="n">write_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert CTA IRF data from ROOT to FITS format.</span>

<span class="sd">    This script converts a CTA response stored in a root file into a set of FITS</span>
<span class="sd">    files, namely ARF, RMF, and one auxiliary file, which stores all information</span>
<span class="sd">    from the response file in simple fits tables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    irf_root_file_name : str</span>
<span class="sd">        TODO</span>
<span class="sd">    write_output : bool</span>
<span class="sd">        Write output?</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    TODO: at the moment returns nothing ... files should be written by caller!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ROOT</span> <span class="kn">import</span> <span class="n">TFile</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">UnivariateSpline</span>
    <span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erf</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Open CTA response file in root format</span>

    <span class="n">irf_file_name_base</span> <span class="o">=</span> <span class="n">irf_root_file_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Reading IRF data from file {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">irf_root_file_name</span><span class="p">))</span>
    <span class="n">irf_root_file</span> <span class="o">=</span> <span class="n">TFile</span><span class="p">(</span><span class="n">irf_root_file_name</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;File content (f.ls()) :&#39;</span><span class="p">)</span>
    <span class="n">irf_root_file</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span>

    <span class="c">#---------------------------------------------------------------------------</span>
    <span class="c"># Write ARF &amp; MRF</span>

    <span class="c">#----------------------------------------------</span>
    <span class="c"># Read RM</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;MigMatrix&#39;</span><span class="p">)</span>
    <span class="n">rm_erange_log</span><span class="p">,</span> <span class="n">rm_ebounds_log</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">h</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Transpose and normalize RM</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">root_2dhist_to_array</span><span class="p">(</span><span class="n">h</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">rm</span><span class="p">[</span><span class="n">rm</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">/=</span> <span class="n">n</span><span class="p">[</span><span class="n">rm</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="c"># Read bin enery ranges</span>
        <span class="n">rm_erange_log</span> <span class="o">=</span> <span class="n">root_axis_to_array</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">())</span>
        <span class="n">rm_ebounds_log</span> <span class="o">=</span> <span class="n">root_axis_to_array</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;ROOT file does not contain MigMatrix.&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Will produce RMF from ERes histogram.&#39;</span><span class="p">)</span>

        <span class="c"># Read energy resolution</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;ERes&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">root_1dhist_to_array</span><span class="p">(</span><span class="n">h</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">root_axis_to_array</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">())</span>

        <span class="c"># Resample to higher resolution in energy</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>  <span class="c"># 20 bins per decade</span>
        <span class="n">rm_erange_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">rm_ebounds_log</span> <span class="o">=</span> <span class="n">rm_erange_log</span>

        <span class="n">sigma</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">((</span><span class="n">ax</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logerange</span> <span class="o">=</span> <span class="n">rm_erange_log</span>
        <span class="n">logemingrid</span> <span class="o">=</span> <span class="n">logerange</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">nbins</span><span class="p">,</span> <span class="n">nbins</span><span class="p">])</span>
        <span class="n">logemaxgrid</span> <span class="o">=</span> <span class="n">logerange</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">nbins</span><span class="p">,</span> <span class="n">nbins</span><span class="p">])</span>
        <span class="n">logecentergrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(((</span><span class="n">logerange</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logerange</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">nbins</span><span class="p">,</span> <span class="n">nbins</span><span class="p">]))</span>

        <span class="n">gauss_int</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">:</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">erf</span><span class="p">((</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">))</span> <span class="o">-</span> <span class="n">erf</span><span class="p">((</span><span class="n">x_min</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span><span class="p">)))</span>

        <span class="n">rm</span> <span class="o">=</span> <span class="n">gauss_int</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">logecentergrid</span><span class="p">,</span> <span class="n">sigma</span><span class="p">(</span><span class="n">logecentergrid</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">logecentergrid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">logecentergrid</span> <span class="p">],</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">logemingrid</span><span class="p">,</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">logemaxgrid</span><span class="p">)</span>
        <span class="c"># rm = gauss_int([1., 10. ** logecentergrid, .5], 10. ** logemingrid, 10. ** logemaxgrid)</span>

    <span class="c"># Create RM hdulist</span>
    <span class="n">hdulist</span> <span class="o">=</span> <span class="n">np_to_rmf</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span>
                        <span class="p">(</span><span class="mf">10.</span> <span class="o">**</span> <span class="n">rm_erange_log</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                        <span class="p">(</span><span class="mf">10.</span> <span class="o">**</span> <span class="n">rm_ebounds_log</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                        <span class="mf">1E-5</span><span class="p">,</span>
                        <span class="n">telescope</span><span class="o">=</span><span class="s">&#39;CTASIM&#39;</span><span class="p">)</span>

    <span class="c"># Write RM to file</span>
    <span class="k">if</span> <span class="n">write_output</span><span class="p">:</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">irf_file_name_base</span> <span class="o">+</span> <span class="s">&#39;.rmf.fits&#39;</span><span class="p">)</span>

    <span class="c">#----------------------------------------------</span>
    <span class="c"># Read EA</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;EffectiveAreaEtrue&#39;</span><span class="p">)</span>  <span class="c"># ARF should be in true energy</span>
    <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;ROOT file does not contain EffectiveAreaEtrue (EA vs E_true)&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Will use EffectiveArea (EA vs E_reco) for ARF&#39;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;EffectiveArea&#39;</span><span class="p">)</span>
    <span class="n">ea</span> <span class="o">=</span> <span class="n">root_1dhist_to_array</span><span class="p">(</span><span class="n">h</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c"># Read EA bin energy ranges</span>
    <span class="n">ea_erange_log</span> <span class="o">=</span> <span class="n">root_axis_to_array</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">())</span>
    <span class="c"># Re-sample EA to match RM</span>
    <span class="n">resample_ea_to_mrf</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c"># resample_ea_to_mrf = False</span>
    <span class="k">if</span> <span class="n">resample_ea_to_mrf</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Resampling effective area in log10(EA) vs log10(E) to match RM.&#39;</span><span class="p">)</span>
            <span class="n">logea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
            <span class="n">logea</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">logea</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">logea</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">ea_spl</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">((</span><span class="n">ea_erange_log</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">ea_erange_log</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">logea</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">rm_erange_log</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">rm_erange_log</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">ea</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">ea_spl</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">ea</span><span class="p">[</span><span class="n">ea</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">ea_erange_log</span> <span class="o">=</span> <span class="n">rm_erange_log</span>

    <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">np_to_arf</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span>
                      <span class="p">(</span><span class="mf">10.</span> <span class="o">**</span> <span class="n">ea_erange_log</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                      <span class="n">telescope</span><span class="o">=</span><span class="s">&#39;CTASIM&#39;</span><span class="p">)</span>
    <span class="c"># Write AR to file</span>
    <span class="k">if</span> <span class="n">write_output</span><span class="p">:</span>
        <span class="n">tbhdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">irf_file_name_base</span> <span class="o">+</span> <span class="s">&#39;.arf.fits&#39;</span><span class="p">)</span>

    <span class="c">#----------------------------------------------</span>
    <span class="c"># Fit some distributions</span>

    <span class="c"># Broken power law fit function, normalized at break energy</span>
    <span class="n">bpl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">ChisquareFitter</span><span class="p">(</span><span class="n">bpl</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;BGRatePerSqDeg&#39;</span><span class="p">)</span>
    <span class="n">fit_th1</span><span class="p">(</span><span class="n">fitter</span><span class="p">,</span> <span class="p">[</span><span class="mf">3.2</span><span class="p">,</span> <span class="mf">1E-5</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">h</span><span class="p">,</span> <span class="n">errscale</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
    <span class="n">fitter</span><span class="o">.</span><span class="n">print_results</span><span class="p">()</span>
    <span class="n">bgrate_p1</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fitx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;AngRes&#39;</span><span class="p">)</span>
    <span class="n">fit_th1</span><span class="p">(</span><span class="n">fitter</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">],</span> <span class="n">h</span><span class="p">,</span> <span class="n">errscale</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fitter</span><span class="o">.</span><span class="n">print_results</span><span class="p">()</span>
    <span class="n">angres68_p1</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c">#----------------------------------------------</span>
    <span class="c"># Read extra information from response file</span>

    <span class="n">aux_tab</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;BGRate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">331</span><span class="p">)</span>
    <span class="n">plot_th1</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">root_th1_to_fitstable</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">yunit</span><span class="o">=</span><span class="s">&#39;Hz&#39;</span><span class="p">,</span> <span class="n">xunit</span><span class="o">=</span><span class="s">&#39;log(1/TeV)&#39;</span><span class="p">)</span>
    <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME &#39;</span><span class="p">,</span> <span class="s">&#39;BGRATE&#39;</span><span class="p">,</span> <span class="s">&#39;Name of this binary table extension&#39;</span><span class="p">)</span>
    <span class="n">aux_tab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;BGRatePerSqDeg&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">332</span><span class="p">)</span>
    <span class="n">plot_th1</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitx</span><span class="p">,</span> <span class="n">bpl</span><span class="p">(</span><span class="n">bgrate_p1</span><span class="p">,</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">fitx</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitx</span><span class="p">,</span> <span class="n">bpl</span><span class="p">([</span><span class="mf">9.</span><span class="p">,</span> <span class="mf">5E-4</span><span class="p">,</span> <span class="mf">1.44</span><span class="p">,</span> <span class="o">.</span><span class="mi">49</span><span class="p">],</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">fitx</span><span class="p">))</span>
    <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">root_th1_to_fitstable</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">yunit</span><span class="o">=</span><span class="s">&#39;Hz/deg^2&#39;</span><span class="p">,</span> <span class="n">xunit</span><span class="o">=</span><span class="s">&#39;log(1/TeV)&#39;</span><span class="p">)</span>
    <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME &#39;</span><span class="p">,</span> <span class="s">&#39;BGRATED&#39;</span><span class="p">,</span> <span class="s">&#39;Name of this binary table extension&#39;</span><span class="p">)</span>
    <span class="n">aux_tab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;EffectiveArea&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">333</span><span class="p">)</span>
    <span class="n">plot_th1</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">root_th1_to_fitstable</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">yunit</span><span class="o">=</span><span class="s">&#39;m^2&#39;</span><span class="p">,</span> <span class="n">xunit</span><span class="o">=</span><span class="s">&#39;log(1/TeV)&#39;</span><span class="p">)</span>
    <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME &#39;</span><span class="p">,</span> <span class="s">&#39;EA&#39;</span><span class="p">,</span> <span class="s">&#39;Name of this binary table extension&#39;</span><span class="p">)</span>
    <span class="n">aux_tab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;EffectiveArea80&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">334</span><span class="p">)</span>
        <span class="n">plot_th1</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">root_th1_to_fitstable</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">yunit</span><span class="o">=</span><span class="s">&#39;m^2&#39;</span><span class="p">,</span> <span class="n">xunit</span><span class="o">=</span><span class="s">&#39;log(1/TeV)&#39;</span><span class="p">)</span>
        <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME &#39;</span><span class="p">,</span> <span class="s">&#39;EA80&#39;</span><span class="p">,</span> <span class="s">&#39;Name of this binary table extension&#39;</span><span class="p">)</span>
        <span class="n">aux_tab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;EffectiveAreaEtrue&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">335</span><span class="p">)</span>
        <span class="n">plot_th1</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">root_th1_to_fitstable</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">yunit</span><span class="o">=</span><span class="s">&#39;m^2&#39;</span><span class="p">,</span> <span class="n">xunit</span><span class="o">=</span><span class="s">&#39;log(1/TeV)&#39;</span><span class="p">)</span>
        <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME &#39;</span><span class="p">,</span> <span class="s">&#39;EAETRUE&#39;</span><span class="p">,</span> <span class="s">&#39;Name of this binary table extension&#39;</span><span class="p">)</span>
        <span class="n">aux_tab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;AngRes&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">336</span><span class="p">)</span>
    <span class="n">plot_th1</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitx</span><span class="p">,</span> <span class="n">bpl</span><span class="p">(</span><span class="n">angres68_p1</span><span class="p">,</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">fitx</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitx</span><span class="p">,</span> <span class="n">bpl</span><span class="p">([</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">5.5E-2</span><span class="p">,</span> <span class="o">.</span><span class="mi">42</span><span class="p">,</span> <span class="o">.</span><span class="mi">19</span><span class="p">],</span> <span class="mf">10.</span> <span class="o">**</span> <span class="n">fitx</span><span class="p">))</span>
    <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">root_th1_to_fitstable</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">yunit</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">xunit</span><span class="o">=</span><span class="s">&#39;log(1/TeV)&#39;</span><span class="p">)</span>
    <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME &#39;</span><span class="p">,</span> <span class="s">&#39;ANGRES68&#39;</span><span class="p">,</span> <span class="s">&#39;Name of this binary table extension&#39;</span><span class="p">)</span>
    <span class="n">aux_tab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;AngRes80&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">337</span><span class="p">)</span>
    <span class="n">plot_th1</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">root_th1_to_fitstable</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">yunit</span><span class="o">=</span><span class="s">&#39;deg&#39;</span><span class="p">,</span> <span class="n">xunit</span><span class="o">=</span><span class="s">&#39;log(1/TeV)&#39;</span><span class="p">)</span>
    <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME &#39;</span><span class="p">,</span> <span class="s">&#39;ANGRES80&#39;</span><span class="p">,</span> <span class="s">&#39;Name of this binary table extension&#39;</span><span class="p">)</span>
    <span class="n">aux_tab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;ERes&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">339</span><span class="p">)</span>
    <span class="n">plot_th1</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">tbhdu</span> <span class="o">=</span> <span class="n">root_th1_to_fitstable</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">xunit</span><span class="o">=</span><span class="s">&#39;log(1/TeV)&#39;</span><span class="p">)</span>
    <span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;EXTNAME &#39;</span><span class="p">,</span> <span class="s">&#39;ERES&#39;</span><span class="p">,</span> <span class="s">&#39;Name of this binary table extension&#39;</span><span class="p">)</span>
    <span class="n">aux_tab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbhdu</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">338</span><span class="p">)</span>
    <span class="c"># plt.set_cmap(plt.get_cmap(&#39;Purples&#39;))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;jet&#39;</span><span class="p">))</span>
    <span class="c"># plt.imshow(np.log10(rm), origin=&#39;lower&#39;, extent=(rm_ebounds_log[0], rm_ebounds_log[-1], rm_erange_log[0], rm_erange_log[-1]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">rm_ebounds_log</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rm_ebounds_log</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rm_erange_log</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rm_erange_log</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="c"># plt.clim(-2., 1.)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=.</span><span class="mi">08</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=.</span><span class="mi">08</span><span class="p">,</span> <span class="n">right</span><span class="o">=.</span><span class="mi">97</span><span class="p">,</span> <span class="n">top</span><span class="o">=.</span><span class="mi">95</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=.</span><span class="mi">35</span><span class="p">)</span>

    <span class="c"># Create primary HDU and HDU list to be stored in the output file</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span>
    <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu</span><span class="p">]</span> <span class="o">+</span> <span class="n">aux_tab</span><span class="p">)</span>

    <span class="c"># Write extra response data to file</span>
    <span class="k">if</span> <span class="n">write_output</span><span class="p">:</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">irf_file_name_base</span> <span class="o">+</span> <span class="s">&#39;.extra.fits&#39;</span><span class="p">)</span>

    <span class="c"># Close CTA IRF root file</span>
    <span class="n">irf_root_file</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="pyfact.html#">Back to Top</a></p>
  <p>
    &copy; Copyright 2015, The Gammapy developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1. &nbsp;
    Last built 13 Aug 2015. <br/>
  </p>
</footer>
  </body>
</html>